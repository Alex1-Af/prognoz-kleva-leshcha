(()=>{"use strict";class t{static createIconGroup(t,e){return{description:t,icon:`${e}d`,nightIcon:`${e}n`}}static weatherIcons={0:t.createIconGroup("Ясно","01"),1:t.createIconGroup("Преимущественно ясно","02"),2:t.createIconGroup("Переменная облачность","03"),3:t.createIconGroup("Пасмурно","04"),45:t.createIconGroup("Туман","50"),48:t.createIconGroup("Изморозь","50"),51:t.createIconGroup("Морось: слабая","09"),53:t.createIconGroup("Морось: умеренная","09"),55:t.createIconGroup("Морось: сильная","09"),56:t.createIconGroup("Ледяная морось: слабая","13"),57:t.createIconGroup("Ледяная морось: сильная","13"),61:t.createIconGroup("Дождь: слабый","10"),63:t.createIconGroup("Дождь: умеренный","10"),65:t.createIconGroup("Дождь: сильный","10"),66:t.createIconGroup("Ледяной дождь: слабый","13"),67:t.createIconGroup("Ледяной дождь: сильный","13"),71:t.createIconGroup("Снег: слабый","13"),73:t.createIconGroup("Снег: умеренный","13"),75:t.createIconGroup("Снег: сильный","13"),77:t.createIconGroup("Снежные зерна","13"),80:t.createIconGroup("Ливень: слабый","09"),81:t.createIconGroup("Ливень: умеренный","09"),82:t.createIconGroup("Ливень: сильный","09"),85:t.createIconGroup("Снегопад: слабый","13"),86:t.createIconGroup("Снегопад: сильный","13"),95:t.createIconGroup("Гроза: слабая","11"),96:t.createIconGroup("Гроза с градом: слабая","11"),99:t.createIconGroup("Гроза с градом: сильная","11")};static getIconData(t){const e=String(t);return this.weatherIcons[e]||{description:"Неизвестно",icon:"unknown",nightIcon:"unknown"}}static getDominantWeatherDescription(t,e){if(!t||!t.length)return{type:"Нет данных",description:"",icon:"",iconShow:"",descriptionShow:""};const n={Ясно:[0,1],Облачно:[2,3],Туман:[45,48],Морось:[51,53,55,56,57],Дождь:[61,63,65,66,67,80,81,82],Снег:[71,73,75,77,85,86],Гроза:[95,96,99]},i=t.reduce(((t,e)=>{const n=e.code;return"number"==typeof n&&(t[n]=(t[n]||0)+1),t}),{});let r=null,a=0;for(const[t,e]of Object.entries(i)){const n=Number(t);e>a&&(r=n,a=e)}let s="Неизвестно";for(const[t,e]of Object.entries(n))if(e.includes(r)){s=t;break}const o=t.find((t=>t.code===r)),c=this.weatherIcons[String(e)];return{type:s,description:o?.description||"Неизвестно",icon:o?.icon||"unknown",iconShow:c?.icon||"unknown",descriptionShow:c?.description||"Неизвестно"}}static getWeatherType(t){const e=t.code,n=this.weatherIcons[String(e)];return n?.description||"Неизвестно"}static getWeatherDescription(t){return t.description||"Неизвестно"}}class e{static calcTempStats(t,e){return t.length?{avg:e(t.reduce(((t,e)=>t+e),0)/t.length),min:e(Math.min(...t)),max:e(Math.max(...t)),change:e(t[t.length-1]-t[0])}:{avg:null,min:null,max:null,change:null}}static calcPressureStats(t,e){if(!t.length)return{avg:null,min:null,max:null,change:0,isStable:!1};const n=e(t.reduce(((t,e)=>t+e),0)/t.length),i=e(Math.min(...t)),r=e(Math.max(...t));return{avg:n,min:i,max:r,change:t.length>1?e(t[t.length-1]-t[0]):0,isStable:r-i<2}}static degreesToCardinal(t){return["С ↑","СВ ↗","В →","ЮВ ↘","Ю ↓","ЮЗ ↙","З ←","СЗ ↖"][Math.round(t%360/45)%8]}static calcWindStats(t,e=null){const n={avgSpeed:0,avgSpeedStrongWind:0,maxSpeed:0,mainDirection:null,strongWindOnly:!1};if(!Array.isArray(t)||0===t.length)return n;const i=t.filter((t=>t?.speed>=3));return 0===i.length?{...n,avgSpeed:this.round(t.reduce(((t,e)=>t+(e?.speed||0)),0)/t.length),mainDirection:this.degreesToCardinal(e)}:{avgSpeed:this.round(t.reduce(((t,e)=>t+(e?.speed||0)),0)/t.length),avgSpeedStrongWind:this.round(i.reduce(((t,e)=>t+(e?.speed||0)),0)/i.length),maxSpeed:this.round(Math.max(...i.map((t=>t?.speed||0)))),mainDirection:this.degreesToCardinal(e),strongWindOnly:!0}}static calcPrecipStats(t){return null==t?null:parseFloat(t.toFixed(1))}static calcWeather(e,n){return t.getDominantWeatherDescription(e,n)}static round(t,e=0){return parseFloat(t.toFixed(e))}static findExtremes(t){if(!t?.length)return null;const e=t.reduce(((t,e)=>t.tempMax>e.tempMax?t:e)),n=t.reduce(((t,e)=>t.tempMin<e.tempMin?t:e)),i=t.reduce(((t,e)=>t.precipitation>e.precipitation?t:e));return{warmest:e,coldest:n,windiest:t.reduce(((t,e)=>t.windMax>e.windMax?t:e)),wettest:i}}static getRoundedHourTime(){const t=new Date;let e=t.getHours();return t.getMinutes()>=30&&(e+=1),e%=24,`${e.toString().padStart(2,"0")}:00`}}const n=class{constructor(t){this.rawData=t,this.calculator=e,this.processedData={daily:{},stats:{}}}process(){if(!this.validateData())throw new Error("Invalid weather data format");return this.groupDataByDays(),this.calculatePeriodStatistics(),this.processedData}validateData(){return this.rawData&&this.rawData.hourly&&Array.isArray(this.rawData.hourly.time)}groupDataByDays(){this.rawData.hourly.time.forEach(((t,e)=>{const n=t.split("T")[0];this.processedData.daily[n]||this.initDayData(n),this.addHourData(n,e)}))}initDayData(t){this.processedData.daily[t]={date:t,hours:[],temps:[],pressures:[],precipitations:[],winds:[],weatherCodes:[]}}addHourData(t,e){const n=this.processedData.daily[t],i=this.rawData.hourly,r=i.time[e],a=i.temperature_2m[e],s=i.surface_pressure[e],o=i.precipitation[e],c=i.windspeed_10m[e],l=i.winddirection_10m[e],d=i.weathercode[e],h=this.getWeatherCodeEntry(d,r);null!==a&&n.temps.push(a),null!==s&&n.pressures.push(this.calculator.round(.75006*s)),null!==o&&n.precipitations.push(o),null!==c&&null!==l&&n.winds.push({speed:this.calculator.round(.27778*c),direction:l}),null!==d&&n.weatherCodes.push(h),n.hours.push({time:r,temp:a,precipitations:o,pressure:null!==s?this.calculator.round(.75006*s):null,winds:null!==c&&null!==l?{speed:this.calculator.round(.27778*c),direction:l}:null,weatherCodes:h})}getWeatherCodeEntry(e,n){const i=t.getIconData(e);return{code:e,description:i.description,icon:i.icon,nightIcon:i.nightIcon,time:n}}calculatePeriodStatistics(){Object.entries(this.processedData.daily).forEach((([t,e])=>{const n=this.getDailyData(t);this.processedData.stats[t]={temp:this.calculator.calcTempStats(e.temps,this.calculator.round),pressure:this.calculator.calcPressureStats(e.pressures,this.calculator.round),winds:this.calculator.calcWindStats(e.winds,n?.windDirection,this.calculator.round),precipitations:this.calculator.calcPrecipStats(n?.precipitation),weatherCodes:this.calculator.calcWeather(e.weatherCodes,n?.weatherCode)}}))}getDailyData(t){if(!this.rawData.daily?.time)return null;const e=this.rawData.daily.time.indexOf(t);return-1===e?null:{weatherCode:this.rawData.daily.weathercode?.[e],precipitation:this.rawData.daily.precipitation_sum?.[e],windDirection:this.rawData.daily.winddirection_10m_dominant?.[e]}}getDayData(t){return this.processedData.daily[t]}},i=class extends n{constructor(t){super(t),this.processedData={daily:{},stats:{},statsTotal:{}}}processHourly(e,n){const i=[];if(!this.validateData())throw new Error("Invalid weather data format");const r=this.rawData.hourly;for(let e=0;e<Math.min(r.time.length,24);e++){const n=r.time[e],a=r.weathercode[e],s=t.getIconData(a),o=this.calculator.degreesToCardinal(r.winddirection_10m[e]);i.push({time:n,temp:this.calculator.round(r.temperature_2m[e]),precipitations:this.calculator.round(r.precipitation[e],1),pressure:this.calculator.round(.75006*r.surface_pressure[e]),winds:{speed:this.calculator.round(.27778*r.windspeed_10m[e]),direction:o},weatherCodes:{code:a,description:s.description,icon:s.icon,nightIcon:s.nightIcon,time:n}})}const a=t.getIconData(e.weathercode),s=this.calculator.degreesToCardinal(e.winddirection_10m),o=this.calculator.round(e.temperature_2m)-n.temp.avg,c=this.calculator.round(.75006*e.surface_pressure)-n.pressure.avg;return{current:{apparent_temperature:this.calculator.round(e.apparent_temperature),pressure:this.calculator.round(.75006*e.surface_pressure),pressureChange:c,temp:this.calculator.round(e.temperature_2m),tempChange:o,humidity:e.relativehumidity_2m,winds:{speed:this.calculator.round(.27778*e.windspeed_10m),direction:s},weatherCodes:{code:e.weathercode,description:a.description,icon:a.icon,nightIcon:a.nightIcon}},hourly:i}}initDailyData(t){this.processedData.statsTotal[t]={date:t,temp_max:null,temp_min:null,precipitations:null,winds:[],weatherCodes:[]}}addDailyData(e,n){const i=this.rawData.daily,r=this.processedData.statsTotal[e],a=i.weathercode[n],s=t.getIconData(a);null!==i.windspeed_10m_max[n]&&null!==i.winddirection_10m_dominant[n]&&r.winds.push({speed:this.calculator.round(.27778*i.windspeed_10m_max[n]),direction:this.calculator.degreesToCardinal(i.winddirection_10m_dominant[n])}),null!==i.precipitation_sum[n]&&(r.precipitations=this.calculator.round(i.precipitation_sum[n])),null!==i.temperature_2m_max[n]&&(r.temp_max=this.calculator.round(i.temperature_2m_max[n])),null!==i.temperature_2m_min[n]&&(r.temp_min=this.calculator.round(i.temperature_2m_min[n])),i.weathercode&&null!==i.weathercode[n]&&r.weatherCodes.push({code:a,description:s.description,icon:s.icon,nightIcon:s.nightIcon})}process(){return super.process()}validateData(){return super.validateData()}groupDataByDays(){super.groupDataByDays(),this.rawData.daily.time.forEach(((t,e)=>{this.processedData.statsTotal[t]||this.initDailyData(t),this.addDailyData(t,e)}))}initDayData(t){super.initDayData(t)}addHourData(t,e){super.addHourData(t,e)}calculatePeriodStatistics(){super.calculatePeriodStatistics()}getDailyData(t){return super.getDailyData(t)}getDayData(t){return super.getDayData(t)}},r=class extends n{constructor(t){super(t),this.processedData={daily:{},stats:{},totalstats:{},extremes:{}}}calculateTotalStats(){this.dataTotalStats=Object.entries(this.processedData.stats),this.processedData.totalstats={totalPrecipitations:this.calcTotalPrecipitations(),totalTemp:this.calcTotalTempStats(),totalPressure:this.calcTotalPressureStats()}}calcTotalPrecipitations(){const t=this.reduceCustoms((t=>t[1].precipitations));return this.round(t)}calcTotalTempStats(){const t=this.round(this.reduceCustoms((t=>t[1].temp.avg))/this.dataTotalStats.length),e=this.round(Math.min(...this.dataTotalStats.map((t=>t[1].temp.avg)))),n=this.round(Math.max(...this.dataTotalStats.map((t=>t[1].temp.avg)))),i=this.dataTotalStats[0][1].temp.avg,r=this.dataTotalStats[this.dataTotalStats.length-1][1].temp.avg;return{avg:t,min:e,max:n,change:this.round(i-r)}}calcTotalPressureStats(){const t=this.round(this.reduceCustoms((t=>t[1].pressure.avg))/this.dataTotalStats.length),e=this.round(Math.min(...this.dataTotalStats.map((t=>t[1].pressure.avg)))),n=this.round(Math.max(...this.dataTotalStats.map((t=>t[1].pressure.avg))));return{avg:t,min:e,max:n,change:this.round(n-e)}}reduceCustoms(t){return this.dataTotalStats.reduce(((e,n)=>e+t(n)),0)}round(t,e=0){return parseFloat(t.toFixed(e))}process(){const t=super.process();return this.calculateTotalStats(),t}validateData(){return super.validateData()}groupDataByDays(){super.groupDataByDays()}initDayData(t){super.initDayData(t)}addHourData(t,e){super.addHourData(t,e)}calculatePeriodStatistics(){super.calculatePeriodStatistics()}getDailyData(t){return super.getDailyData(t)}getDayData(t){return super.getDayData(t)}};class a{constructor(t){this.dailyContainer=document.getElementById("weather-container"),this.processedData=t,this.daysStats=Object.entries(this.processedData.stats)}renderHistoricalDailyWeather(){this.dailyContainer.innerHTML="",this.renderHistoricalDailyStats(),this.renderHistoricalTotalStats()}renderHistoricalDailyStats(){for(const[t,e]of this.daysStats){const n=document.createElement("div");n.className="day-card",n.innerHTML=`\n\t\t  <div class="day-header">\n\t\t\t <div class="date">${t}</div>\n\t\t\t ${e.weatherCodes.icon?`\n\t\t\t <div class="weather-icon-container">\n\t\t\t\t <img src="https://openweathermap.org/img/wn/${"unknown"!==e.weatherCodes.iconShow?e.weatherCodes.iconShow:e.weatherCodes.icon}@2x.png" \n\t\t\t\t alt="${e.weatherCodes.type}" class="weather-icon">\n\t\t\t\t <div class="weather-desc">${"Неизвестно"!==e.weatherCodes.descriptionShow?e.weatherCodes.descriptionShow:e.weatherCodes.description}</div>\n\t\t\t </div>`:""}\n\t\t\t \n\t\t\t \n\t\t\t \n\t\t  </div>\n\t\t  <div class="weather-details">\n\t\t\t ${e.temp.avg?`\n\t\t\t <div class="detail-card temperature">\n\t\t\t\t<div class="detail-label">Температура</div>\n\t\t\t\t<div class="detail-value">${e.temp.min}° - ${e.temp.max}°</div>\n\t\t\t\t\n\t\t\t\t<div class="detail-value">\n\t\t\t\t<span class="detail-label">Средняя</span> <span class="temp-avg-history">${e.temp.avg}°</span>\n\t\t\t\t${e.temp.change?`\n\t\t\t\t<div class="detail-change ${e.temp.change>0?"positive":"negative"}">\n\t\t\t\t  ${e.temp.change>0?"↑":"↓"} ${Math.abs(e.temp.change)}°\n\t\t\t\t</div>`:""}\n\t\t\t\t</div>\n\t\t\t </div>`:""}\n\n\t\t\n\t\t\t \n\t\t\t \n\t\t\t ${e.precipitations?`\n\t\t\t <div class="detail-card precipitation">\n\t\t\t\t<div class="detail-label">Осадки 💧</div>\n\t\t\t\t<div class="detail-value">${e.precipitations} мм</div>\n\t\t\t </div>`:""}\n\t\t\t \n\t\t\t ${e.pressure.avg?`\n\t\t\t <div class="detail-card pressure">\n\t\t\t\t<div class="detail-label">Давление</div>\n\t\t\t\t<div class="detail-value">${e.pressure.avg}\n\t\t\t\t<span class="detail-unit">мм рт.ст.</span></div>\n\t\t\t\t${e.pressure.change?`\n\t\t\t\t<div class="detail-change ${e.pressure.change>0?"positive":"negative"}">\n\t\t\t\t  ${e.pressure.change>0?"↑":"↓"} ${Math.abs(e.pressure.change)}\n\t\t\t\t</div>`:""}\n\t\t\t </div>`:""}\n\t\t\t \n\t\t\t ${e.winds.avgSpeed?`\n\t\t\t <div class="detail-card wind">\n\t\t\t\t<div class="detail-label">Ветер</div>\n\t\t\t\t<div class="detail-value">${e.winds.avgSpeed} м/с</div>\n\t\t\t\t<div class="detail-unit"> ${e.winds.mainDirection||""}</div>\n\t\t\t </div>`:""}\n\t\t  </div>\n\t\t`,this.dailyContainer.appendChild(n)}}renderHistoricalTotalStats(){const t=this.processedData.totalstats,e=document.createElement("div");e.className="day-total",e.innerHTML=`\n\t\t\t  <h3>📊 Тенденции за ${this.daysStats.length} дней</h3>\n\t\t\t  ${t.totalPressure.change?`\n\t\t\t  <div class="trend-item">\n\t\t\t\t\t<span>Среднее давление:</span>\n\t\t\t\t\t<span>${t.totalPressure.avg} мм рт.ст.</span>\n\t\t\t\t\t<span class="detail-change  ${t.totalPressure.change>0?"positive":"negative"}">${t.totalPressure.change>0?"↑":"↓"} ${t.totalPressure.change}мм рт.ст.</span>\n\t\t\t  </div>`:""}\n\t\t\t  <div class="trend-item">\n\t\t\t\t\t<span>💧 Всего осадков:</span>\n\t\t\t\t\t<span>${t.totalPrecipitations} мм</span>\n\t\t\t  </div>\n\t\t\t  <div class="trend-item">\n\t\t\t\t\t<span>Средняя температура:</span>\n\t\t\t\t\t<span>${t.totalTemp.avg}°C</span>\n\t\t\t\t\t<span class="detail-change  ${t.totalTemp.change>0?"positive":"negative"}">${t.totalTemp.change>0?"↑":"↓"} ${t.totalTemp.change}°C</span>\n\t\t\t  </div>\n\t\t `,this.dailyContainer.appendChild(e)}}class s{static getMoonPhase(t=new Date){const e=t.getUTCFullYear(),n=t.getUTCMonth()+1,i=t.getUTCDate(),r=t.getUTCHours();n<3&&(e--,n+=12);const a=Math.floor(e/100),s=(2-a+Math.floor(a/4)+i+Math.floor(365.25*(e+4716))+Math.floor(30.6001*(n+1))-1524.5+r/24-2451550.1)/29.53058867%1;return s<0?s+1:s}static getLunarDay(t=new Date){const e=this.getMoonPhase(t);let n=Math.floor(29.53058867*e)+1;return n<1&&(n=1),n>30&&(n=30),n}static getMoonPhaseInfo(t){const e=29.53058867,n=15/e,i=13.75/e;return[{icon:"🌑",name:"Новолуние",range:[0,.02]},{icon:"🌒",name:"Молодая луна",range:[.02,.23]},{icon:"🌓",name:"Первая четверть",range:[.23,.27]},{icon:"🌔",name:"Растущая луна",range:[.27,i]},{icon:"🌕",name:"Полнолуние",range:[i,n]},{icon:"🌖",name:"Убывающая луна",range:[n,.73]},{icon:"🌗",name:"Последняя четверть",range:[.73,.77]},{icon:"🌘",name:"Старая луна",range:[.77,.97]},{icon:"🌑",name:"Новолуние",range:[.97,1]}].find((e=>t>=e.range[0]&&t<e.range[1]))}}class o{constructor(t,e){this.data=t,this.precipitation=e,this.elements={currentTemp:document.getElementById("current-temp"),currentDesc:document.getElementById("current-desc"),feelsLike:document.getElementById("feels-like"),humidity:document.getElementById("humidity"),wind:document.getElementById("wind"),pressure:document.getElementById("pressure"),currentIcon:document.getElementById("current-icon"),iconMoon:document.getElementById("current-moon-icon"),moonPhase:document.getElementById("current-moon-phase"),moonPhaseContainer:document.getElementById("moon-phase")}}renderCurrentWeather(){const t=s.getMoonPhase(),{icon:n,name:i}=s.getMoonPhaseInfo(t),r=`https://openweathermap.org/img/wn/${["00:00","01:00","02:00","03:00","21:00","22:00","23:00"].includes(e.getRoundedHourTime())?this.data.weatherCodes.nightIcon:this.data.weatherCodes.icon}@2x.png`,a=`<span class="current-temp">${this.data.temp}°C\n\t\t${this.data.tempChange?`\n\t\t<span class="detail-change ${this.data.tempChange>0?"positive":"negative"}">\n\t\t  ${this.data.tempChange>0?"↑":"↓"} ${this.data.tempChange}°\n\t\t</span>`:""} \n\t\t</span>`,o=`<span class="current-pressure">${this.data.pressure} мм рт.ст.\n\t\t${this.data.pressureChange?`\n\t\t<span class="detail-change ${this.data.pressureChange>0?"positive":"negative"}">\n\t\t  ${this.data.pressureChange>0?"↑":"↓"} ${this.data.pressureChange}°\n\t\t</span>`:""} \n\t\t</span>`,c=document.createElement("div");c.className="current-desc precipitation-item",c.textContent=`💧 ${this.precipitation} мм`,this.elements.iconMoon.textContent=n,this.elements.moonPhase.textContent=i,this.elements.currentTemp.innerHTML=a,this.elements.currentDesc.textContent=this.data.weatherCodes.description,this.elements.feelsLike.textContent=`${this.data.apparent_temperature}°C`,this.elements.humidity.textContent=`${this.data.humidity}%`,this.elements.pressure.innerHTML=o,this.elements.wind.textContent=`${this.data.winds.speed} м/с, ${this.data.winds.direction}`,this.elements.currentIcon.innerHTML=`<img src="${r}" alt="${this.data.weatherCodes.description}">`,this.precipitation&&this.elements.moonPhaseContainer.insertAdjacentHTML("afterend",`<div class="precipitation-item">Осадки 💧 ${this.precipitation} мм</div>`)}}class c{constructor(t){this.hourlyContainer=document.getElementById("hourly-forecast"),this.processedData=t}renderHourlyWeather(){this.hourlyContainer.innerHTML="";const t=["00:00","03:00","06:00","09:00","12:00","15:00","18:00","21:00"];this.showTimeDate=this.processedData.hourly.filter((e=>{const n=e.time.split("T")[1];return t.includes(n)})),this.showTimeDate.forEach((t=>{const e=document.createElement("div");e.className="hourly-item",e.innerHTML=this.createHourlyItemHTML(t),this.hourlyContainer.appendChild(e)}))}createHourlyItemHTML(t){const e=t.time.split("T")[1],n=t.temp,i=t.precipitations,r=`https://openweathermap.org/img/wn/${["00:00","03:00","21:00"].includes(e)?t.weatherCodes.nightIcon:t.weatherCodes.icon}.png`,a=`${t.winds.speed} м/с,\n\t\t ${t.winds.direction}`,s=`${t.pressure} мм рт.ст.`;return`\n\t\t <div class="hourly-time">${e}</div>\n\t\t <div class="hourly-icon"><img src="${r}" class="weather-icon" alt="${t.weatherCodes.description}"></div>\n\t\t <div class="hourly-temp">${n}°C</div>\n\t\t \x3c!--<div class="hourly-desc">${t.weatherCodes.description}</div>--\x3e\n\t\t <div class="hourly-wind">${a}</div>\n\t\t <div class="hourly-pressure">${s}</div>\n\t\t ${i?`\n\t\t <div class="hourly-pressure">💧 ${i} мм\n\t\t </div>`:""}\n\t  `}}class l{constructor(t){this.dailyContainer=document.getElementById("daily-forecast"),this.processedData=t,this.daysStats=Object.entries(this.processedData.stats)}renderDailyWeather(){this.dailyContainer.innerHTML="",this.daysStats.forEach((([t,e])=>{const n=new Date(t+"T00:00:00"),i=n.toLocaleDateString("ru-RU",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"Europe/Kiev"}),r=s.getMoonPhase(n),{icon:a,name:o}=s.getMoonPhaseInfo(r),c=document.createElement("div");c.className="daily-item",c.innerHTML=`\n\t\t\t\t  <div class="daily-day">${i}</div>\n\t\t\t\t  <div class="daily-icon"><img src="https://openweathermap.org/img/wn/${e.weatherCodes.iconShow}.png" class="weather-icon" alt="${e.weatherCodes.descriptionShow}"></div>\n\t\t\t\t  <div class="daily-temp">${e.temp.min}° - ${e.temp.max}°\n\t\t\t\t  </div>\n\t\t\t\t  <div class="daily-temp-avg">Средняя <span class="temp-avg"> ${e.temp.avg}°</span>\n\t\t\t\t  ${e.temp.change?`\n\t\t\t\t  <span class="detail-change ${e.temp.change>0?"positive":"negative"}">\n\t\t\t\t\t ${e.temp.change>0?"↑":"↓"} ${Math.abs(e.temp.change)}°\n\t\t\t\t  </span>`:""} \n\t\t\t\t  </div>\n\n\t\t\t\t  <div>${e.weatherCodes.descriptionShow}</div>\n\t\t\t\t  <div class="hourly-wind">${e.winds.avgSpeed} м/с, ${e.winds.mainDirection||""}</div>\n\t\t\t\t  <div class="hourly-pressure">${e.pressure.avg} мм рт.ст.\n\t\t\t\t  ${e.pressure.change?`\n\t\t\t\t  <span class="detail-change ${e.pressure.change>0?"positive":"negative"}">\n\t\t\t\t  ${e.pressure.change>0?"↑":"↓"} ${Math.abs(e.pressure.change)} \n\t\t\t\t  </span>`:""} \n\t\t\t\t  <div class="daily-moon">\n\t\t\t\t\t\t<div class="daily-moon-icon">${a}</div>\n\t\t\t\t\t\t<div>${o}</div>\n\t\t\t\t  </div>\n\t\t\t\t  ${e.precipitations?`\n\t\t\t\t  <div class="hourly-pressure">Осадки 💧 ${e.precipitations} мм</div>`:""} \n\t\t\t\t `,this.dailyContainer.appendChild(c)}))}displayMoonPhase(){const t=s.getMoonPhase(),{icon:e,name:n}=s.getMoonPhaseInfo(t);this.elements.iconMoon.textContent=e,this.elements.moonPhase.textContent=n}}class d{renderHistorical(t){return new a(t).renderHistoricalDailyWeather()}renderCurrent(t,e){return new o(t,e).renderCurrentWeather()}renderHourly(t){return new c(t).renderHourlyWeather()}renderDaily(t){return new l(t).renderDailyWeather()}}class h{constructor(){this.dailyData={},this.renderer=new d}updateHistoricalData(t){this.processorHistoricalData=new r(t),this.processedHistData=this.processorHistoricalData.process();const e=Object.values(this.processedHistData.stats);this.lastHistoricalDay=e[e.length-1],this.renderData=this.renderer.renderHistorical(this.processedHistData)}updateDailyData(t){this.rawData={daily:t.forecast.daily,hourly:t.forecast.hourly},this.processorDailyData=new i(this.rawData),this.data=this.processorDailyData.process();const e=t.current,n=t.forecast.daily.precipitation_sum[0],{todayData:r,forecastWindow:a}=this.extractProcessedForecastWindow(this.data,e);this.hourlyData=this.processorDailyData.processHourly(e,this.lastHistoricalDay),this.renderCurrentData=this.renderer.renderCurrent(this.hourlyData.current,n),this.renderHourlyData=this.renderer.renderHourly(this.hourlyData),this.renderData=this.renderer.renderDaily(a)}extractProcessedForecastWindow(t,e){const n=Object.keys(t.daily),i=n[0],r=n.slice(1,6),a={daily:{[i]:{...t.daily[i]}},stats:{[i]:t.stats[i]}},s={daily:{},stats:{}};r.forEach((e=>{const n=t.daily[e];s.daily[e]={...n,hours:Array.isArray(n.hours)?n.hours:[]},s.stats[e]=t.stats[e]}));const o={extremes:t.extremes,statsTotal:t.statsTotal,current:e};return{todayData:{...a,...o},forecastWindow:{...s,...o}}}}class u{static DAYS=6;static DAYS_ARCHIVE=5;static DEFAULT_LOCATION={latitude:50.45,longitude:30.52,timezone:"Europe/Kyiv"};static BASE_URL="https://api.open-meteo.com/v1/forecast";static CURRENT_PARAMS=["temperature_2m","apparent_temperature","relativehumidity_2m","windspeed_10m","winddirection_10m","surface_pressure","weathercode"].join(",");static COMMON_PARAMS=["temperature_2m","surface_pressure","weathercode","windspeed_10m","winddirection_10m","precipitation"].join(",");static DAILY_PARAMS=["weathercode","temperature_2m_max","temperature_2m_min","precipitation_sum","windspeed_10m_max","windgusts_10m_max","winddirection_10m_dominant"].join(",");static formatDate(t){return new Date(Date.now()-864e5*t).toISOString().split("T")[0]}static buildArchiveUrl(){return`https://archive-api.open-meteo.com/v1/archive?${new URLSearchParams({...this.DEFAULT_LOCATION,start_date:this.formatDate(this.DAYS_ARCHIVE),end_date:this.formatDate(1),hourly:this.COMMON_PARAMS,daily:this.DAILY_PARAMS})}`}static buildWeatherUrl(){const t=new URLSearchParams({...this.DEFAULT_LOCATION,forecast_days:this.DAYS.toString(),current:this.CURRENT_PARAMS,hourly:this.COMMON_PARAMS,daily:this.DAILY_PARAMS});return`${this.BASE_URL}?${t}`}}class m{static async fetchWeather(){const t=u.buildWeatherUrl(),e=await fetch(t);if(!e.ok)throw new Error("Ошибка получения прогноза погоды");const n=await e.json();return{current:n.current,forecast:{hourly:n.hourly,daily:n.daily}}}static async fetchHistoricalData(){const t=u.buildArchiveUrl(),e=await fetch(t);if(!e.ok)throw new Error("Ошибка получения исторических данных");return await e.json()}}class g{static async loadJSON(t){const e=`./files/${t}`;try{const n=await fetch(e);if(!n.ok)throw new Error(`Ошибка загрузки файла ${t}: ${n.statusText}`);return await n.json()}catch(e){throw new Error(`Не удалось загрузить ${t}: ${e.message}`)}}static async loadAll(){try{const[t,e,n]=await Promise.all([this.loadJSON("calendar.json"),this.loadJSON("calendar-moon.json"),this.loadJSON("terms-moon.json")]);return{calendar:t,moonCalendar:e,moonTerms:n}}catch(t){throw new Error(`Ошибка загрузки справочных данных: ${t.message}`)}}}class p{static getSeason(t){const e=new Date(t).getMonth()+1;return e>=3&&e<=5?"spring":e>=6&&e<=8?"summer":e>=9&&e<=11?"autumn":"winter"}static calculate(t){if(t)return{night:t.slice(0,6),morning:t.slice(6,12),day:t.slice(12,18),evening:t.slice(18,24)}}static generateTimeForPeriod(t,e,n){const i={night:{start:0,count:6},morning:{start:6,count:6},day:{start:12,count:6},evening:{start:18,count:6}}[n];if(!i)throw new Error("Неизвестный период: "+n);const r=i.start+t;return`${String(r).padStart(2,"0")}:00`}static calculateAvgSpeed(t){return t&&0!==t.length?(t.reduce(((t,e)=>t+e.speed),0)/t.length).toFixed(1):"0.0"}static getDominantDirection(t){const e=t.reduce(((t,{description:e})=>{const n=e.split(" — ")[0];return t[n]=(t[n]||0)+1,t}),{}),n=Object.entries(e).sort(((t,e)=>e[1]-t[1]));return n.length>0?n[0][0]:"Н/Д"}static findBestTimeEntry(t){return t&&0!==t.length?t.reduce(((t,e)=>e.evaluation.score>t.evaluation.score?e:t)):{time:"00:00",evaluation:{score:0,description:"Нет данных"}}}static formatTimeBasic(t){if(!t)return"--:--";const[e,n]=t.split(":");return`${e.padStart(2,"0")}:${(n||"00").padStart(2,"0")}`}static evaluateBreamWind(t,n,i=null,r=null,a,s=null,o,c){const l=r?n-r:0,d=i?Math.abs(t-i):0,h=s?a-s:0,u=parseInt(c.split(":")[0],10),m=e.degreesToCardinal(t),g=["Ю ↓","ЮЗ ↙","З ←"].includes(m),p=["СЗ ↖","ЮВ ↘"].includes(m),y=["С ↑","СВ ↗","В →"].includes(m),w=[],v=[];let f=0,$="";$=g?"Благоприятное направление ветра":p?"Нейтральное направление ветра":y?"Неблагоприятное направление ветра":"неопределённое направление",w.push($);let D="";if(D=n<=1?"штиль":n<=3?"оптимальная скорость":n<=6?"умеренный ветер":"🌊 слишком сильный ветер",w.push(D),g&&n>1&&n<=3)f=4;else if(g&&n<=1)switch(!0){case u>=18&&u<=23:f=o?4:3;break;case u>=4&&u<=10:f=3;break;case u>=11&&u<=17:f=2;break;default:f=3}else if(g&&n>3&&n<=6)f=3;else if(g&&n>6)f=1;else if(p&&n>1&&n<=3)f=3;else if(p&&n<=1)switch(!0){case o&&u>=18&&u<=23:f=o?4:3;break;case u>=4&&u<=10:f=3;break;case u>=11&&u<=17:f=1;break;default:f=3}else if(p&&n>3&&n<=6)f=2;else if(p&&n>6)f=0;else if(y&&n>1&&n<=3)f=2;else if(y&&n<=1)switch(!0){case o&&u>=18&&u<=23:case u>=6&&u<=10:f=3;break;case u>=11&&u<=17:f=1;break;default:f=3}else y&&n>3&&n<=6?f=1:y&&n>6&&(f=0);if(l>3){const t=`💨 Резкий рост скорости: с ${r} до ${n} м/с`;v.push(t),f=f>=2?2:f}if(d>=60&&d<=300&&(n>1||r>1)&&t!==i){const t=e.degreesToCardinal(i);n>3&&n<=6?f=Math.min(f,1):n>1&&n<=3&&(f=Math.min(f,2));const r=`⚠️ Резкая смена направления: с ${t} на ${m}`;v.push(r)}let b="";if(-2===h){b=`📉 🎣 Резкое падение давления: ↓ ${Math.abs(h)} мм рт.ст.\n\t\t\t\tВначале всплеск активности у поверхности. ⚠️ Последующие 3-4 часа ухудшение клева - миграция к бровкам с глубиной 3-4 м`,v.push(b);const t=f+1;f=t>4?4:t}else if(h<-2){b=`📉 🎣 Резкое падение давления: ↓ ${Math.abs(h)} мм рт.ст.\n\t\t\t\t\tВначале всплеск активности у поверхности. ⚠️ Через 2 часа - переход на средние глубины 🚫 Через 4 часа - возможен спад клёва`,v.push(b);const t=f+1;f=t>3?3:t}else h>=2&&(f=h>2?0:1,b=`📉 🚫 Резкий рост давления: ↑ ${Math.abs(h)} мм рт.ст.\n\t\t\t\t\tклёв прекратится на 2-3 часа ⚠️ Через 3 часа возможен осторожный клёв у дна 🎣 Через 6 часов - восстановление активности`,v.push(b));let S="",C="";switch(f){case 4:S="✔️",C="отличный клёв";break;case 3:S="✔️",C="активный клёв";break;case 2:S="",C="возможный клёв";break;case 1:S="⚠️",C="нестабильный клёв";break;default:S="🚫",C="нулевой клёв"}return{score:f,description:`${m} — ${S} ${w.join(", ")} — (${n} м/с) \n\t\t${v.length>0?v.join(", "):""} — ${C}`}}static normalizePrecipitationsData(t,e){const n=[];for(const[t,i]of e)n.push({date:t,source:"history",precipitations:i.precipitations??0,temp:i.temp.avg??null});for(const[e,i]of Object.entries(t))n.push({date:e,source:"forecast",precipitations:i.precipitations??0,temp:i.temp.avg??null});return n}static calcTempAvgCurrentTemp(t,e){const n=p.getSeason(t),i=e.find((e=>e.date===t)),r=i?i.temp:null,a=new Date(t),s=e.filter((t=>new Date(t.date)<a)).slice(-5);return s.length<5?"Недостаточно данных":[r,p.round(s.reduce(((t,e)=>t+e.temp),0)/5),n]}static round(t,e=0){return parseFloat(t.toFixed(e))}}class y{constructor(){}renderMoonCurrentDay(t){this.container=document.querySelector(`[data-date="${t.date}"]`),this.moonTodayMainContainer=this.container?.querySelector(".detail-today-main-fishing__moon"),this.moonMorningMainContainer=this.container?.querySelector(".detail-morning-moon-fishing"),this.moonDayMainContainer=this.container?.querySelector(".detail-day-moon-fishing"),this.moonEveningMainContainer=this.container?.querySelector(".detail-evening-moon-fishing");const e=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");e.innerHTML=`\n\t\t<div> \n\t\t  ${t.icon||""} \n\t\t  ${t.name||""} \n\t\t  ${t.moonDay||""} день лунного цикла\n\t\t  ${t.utroDescr.source&&t.utroDescr.source.toLowerCase()!==t.name.toLowerCase()?t.utroDescr.source:""}\n\t\t\t. ${t.utroDescr?.description?.general||""} \n\t\t</div>\n\t `,n.innerHTML=`\n\t\t<p>Влияние луны ${t.icon} ${t?.utroDescr?.description?.utro}</p>\n\t\t`,i.innerHTML=`\n\t\t<p>Влияние луны${t.icon} ${t?.utroDescr?.description?.den} </p>\n\t\t`,r.innerHTML=`\n\t\t<p>Влияние луны${t.icon} ${t?.utroDescr?.description?.vecher} </p>\n\t\t`,this.moonTodayMainContainer?.appendChild(e),this.moonMorningMainContainer?.appendChild(n),this.moonDayMainContainer?.appendChild(i),this.moonEveningMainContainer?.appendChild(r)}}class w{constructor(t,e){this.moonCalendar=t,this.moonTerms=e,this.moonFishingForecastRender=new y}calculate(t,e){const n=!e.includes("Ясно"),i=t.toISOString().split("T")[0],r=s.getLunarDay(t),a=s.getMoonPhase(t),{icon:o,name:c}=s.getMoonPhaseInfo(a),l=p.getSeason(t),d=this.moonCalendar?.[r]?.[l]||{},h=JSON.parse(JSON.stringify(d)),u=h?.utro?.term,m=this.moonTerms?.[l]?.[u]||{},g=JSON.parse(JSON.stringify(m));n&&this.applyCloudEffect(r,l,h,g.description);const y={date:i,moonDay:r,phase:a,utroDescr:g,moonDayInfo:h,icon:o,name:c},w={date:i,model:"moon",morning:h?.utro?.coefficient||0,day:h?.den?.coefficient||0,evening:h?.vecher?.coefficient||0};return this.moonFishingForecastRender.renderMoonCurrentDay(y),w}applyCloudEffect(t,e,n,i){const r=this.getCloudEffect(t,e);if(!r)return;const{target:a,operation:s,value:o,time:c,text:l}=r;(c?[c]:["utro","den","vecher"]).forEach((t=>{const e=n[t][a];"coefficient"===a?n[t][a]=Math.min(e*o,1):"modifier"===a&&("multiply"===s?n[t][a]=e<0?e/o:e*o:n[t][a]+=o),i[t]+=` ${l}`}))}getCloudEffect(t,e){switch(e){case"spring":switch(t){case 3:case 4:return{target:"modifier",operation:"multiply",value:1.2,time:"utro",text:"Облачность усиливает клев"};case 9:case 10:return{target:"coefficient",operation:"multiply",value:1.3,time:null,text:"Облачность снижает негативное влияние лунного света"};default:return null}case"summer":switch(t){case 15:case 16:return{target:"modifier",operation:"add",value:1,time:"den",text:"Облачность повышает активность леща"};case 20:case 21:return{target:"modifier",operation:"multiply",value:1.4,time:"vecher",text:"Облачность усиливает клев"};default:return null}case"autumn":switch(t){case 27:case 28:return{target:"modifier",operation:"add",value:1,time:"utro",text:"Облачность усиливает клев"};default:return null}default:return null}}}class v{renderSeasonCurrentDay(t,e){this.container=document.querySelector(`[data-date="${t}"]`),this.mainTodayMainContainer=this.container?.querySelector(".detail-today-main-fishing__season");const n=document.createElement("div");n.innerHTML=`\n\t\t<div> \n\t\t   ${e||""}\n\t\t</div>\n\t\t`,this.mainTodayMainContainer?.appendChild(n)}}class f{constructor(){this.levelClasses={very_weak:"very_weak",weak:"weak",average:"medium",good:"good",excellent:"excellent"}}calculate(t,e){if(!Array.isArray(e)||0===e.length)return"";const n=e.find((e=>{const n=new Date(t),i=new Date(e.date_from),r=new Date(e.date_to);return n>=i&&n<=r})),i=n.bite_level||"unknown",r=`\n\t\t\t<div class="${this.levelClasses[i]||"unknown"}">\n\t\t\t  <h4>🎣 ${this.formatDateRange(n.date_from,n.date_to)}</h4>\n\t\t\t  <p><strong>${this.getLevelComment(i)}</strong></p>\n\t\t\t  <p>${n.comment||""}</p>\n\t\t\t</div>`.trim(),a={date:t,level:i};return this.seasonFishingForecastRender=new v,this.seasonFishingForecastRender.renderSeasonCurrentDay(t,r),a}formatDateRange(t,e){return`Общий прогноз клёва с ${new Date(t).toLocaleDateString("ru-RU",{day:"numeric",month:"long"})} по ${new Date(e).toLocaleDateString("ru-RU",{day:"numeric",month:"long"})}`}getLevelComment(t){switch(t){case"very_weak":return"В целом сезонные показатели клёва крайне слабые.";case"weak":return"В целом сезонные показатели клёва слабо выражены.";case"medium":return"Клёв нестабильный, возможны локальные улучшения.";case"good":return"Хороший период для рыбалки, высокая вероятность клёва.";case"excellent":return"Отличный период — лещ активно кормится, клёв интенсивный.";default:return"Нет данных по интенсивности клёва."}}}class ${constructor(){}calculate(t,e){const[n,i]=t,r=p.calculate(n),a=r.day.reduce(((t,e)=>t+e.speed),0)/r.day.length>=2,s=n.map(((t,e)=>({speed:t.speed,direction:t.direction,speedDayTrue:a,pressure:i[e]}))),o=p.calculate(s),c=this.calculateWindStats(o),l={general:null,morning:this.round(c.morning.avgScore),day:this.round(c.day.avgScore),evening:this.round(c.evening.avgScore),model:"wind"},d=this.analyzeNightWind(o.night,c.night),h=this.collectCriticalNotes(n,i,e);this.result=this.buildForecast(c,d,h,e,l)}getResult(){return this.result}getModelType(){return"wind"}collectCriticalNotes(t,e,n){const i=[];return this.detectSensitivePeriods(t,n,i),this.addTrendNotes(t,i),this.mergeBadWindNotes(i)}addTrendNotes(t,e){const n=this.buildWindNotes(t);for(const t of n)this.pushUniqueNote(t,e)}formatHour(t,e){const n=new Date(t);return n.setHours(e),n.toTimeString().slice(0,5)}buildWindNotes(t){const n=[];let i=null,r="",a=null,s="",o=!1;for(let c=0;c<t.length;c++){const{direction:l,speed:d}=t[c],h=this.getHourTime(t[c],c),u=e.degreesToCardinal(l);null!==i&&u!==r&&d>1&&this.detectSuddenChange(n,l,i,r,u,h),this.isBadDirection(u)&&d>1?a||(a=h,s=u):a&&(this.pushBadWindBlock(n,a,h,s),a=null),!o&&this.isGoodDirection(u)&&d<=3&&(n.push({time:h,comment:`✔️ С ${h} ветер сменился на ${u} и ослаб — возможное восстановление клёва.`}),o=!0),i=l,r=u}if(a){const e=t[t.length-1].time||`${String(t.length-1).padStart(2,"0")}:00`;this.pushBadWindBlock(n,a,e,s)}return n}getHourTime(t,e){return t.time||`${String(e).padStart(2,"0")}:00`}detectSuddenChange(t,e,n,i,r,a){const s=Math.abs(e-n);s>=60&&s<=300&&t.push({time:a,comment:`⚠️ Резкая смена направления ветра: с ${i} на ${r}`})}pushBadWindBlock(t,e,n,i){e===n?t.push({time:e,comment:`🚫 Неблагоприятное направление ветра (${i}) может ухудшить клёв`}):t.push({time:`${e}–${n}`,comment:`🚫 С ${e} до ${n} преобладал ветер ${i}, что могло негативно повлиять на клёв.`})}isBadDirection(t){return["С ↑","СВ ↗","В →"].includes(t)}isGoodDirection(t){return["Ю ↓","ЮЗ ↙","З ←"].includes(t)}pushUniqueNote(t,e){if(!t.time||parseInt(t.time.split(":")[0])<4)return;const n=t.comment.trim().slice(0,2);if(!e.find((e=>e.time===t.time&&e.comment.trim().startsWith(n)))){const n=e.find((e=>e.time===t.time));n?n.comment.includes(t.comment)||(n.comment+=" "+t.comment):e.push(t)}}detectSensitivePeriods(t,e,n){for(let i=0;i<t.length-2;i++){const r=t[i],a=t[i+1],s=t[i+2],o=Math.abs(s.direction-r.direction),c=s.speed-r.speed,l=i+2;if((l>=4&&l<=8||l>=18&&l<=22)&&(o>45||c>2)&&(r.speed>2||a.speed>2||s.speed>2)){const t=this.formatHour(e,l);this.pushUniqueNote({time:t,comment:"🌅 Изменение ветра в чувствительный период (утро/вечер)"},n)}}}calculateWindStats(t={}){return{night:this.getWindStats(t.night||[],"night"),morning:this.getWindStats(t.morning||[],"morning"),day:this.getWindStats(t.day||[],"day"),evening:this.getWindStats(t.evening||[],"evening")}}analyzeNightWind(t,n){let i="";for(const{direction:e,speed:n}of t){if(e>=60&&e<=100&&n>=2){i="📍 Ночью ветер дул с востока в сторону левого берега. 🎣 Возможно скопление рыбы у левого берега утром.</br>";break}if(e>=240&&e<=280&&n>=2){i="📍 Ночью ветер дул с запада в сторону правого берега. 🎣 Утром стоит попробовать ловлю у правого берега.</br>";break}}const r=t.slice(-3).map((t=>({dir:e.degreesToCardinal(t.direction),speed:t.speed})));return r.some((t=>"В →"===t.dir))&&r[2].speed<r[0].speed&&(i+=" ⚠️ Восточный ветер ослаб к утру, это может улучшить клёв. ✔️"),i}buildForecast(t,e,n,i,r){const a=this.buildHourlyDetails(t);let s=n.length?n.reduce(((t,e)=>t+e.time+" - "+e.comment+"\n"),""):null;return"string"==typeof s&&(s=[...new Set(s.split("\n"))].join("<br>")),{date:i,details:{morning:[this.describeWindEffect(t.morning,"💨 Влияние ветра"),...a.morning],day:[this.describeWindEffect(t.day,"💨 Влияние ветра"),...a.day],evening:[this.describeWindEffect(t.evening,"💨 Влияние ветра"),...a.evening]},weights:r,general:[this.buildGeneralNote(t,e),s,this.buildSummary(t)].filter(Boolean)}}buildGeneralNote(t,e){let n=`💨 Ветровые условия за сутки:</br>• 🌅 Утро: ${t.morning.avgSpeed} м/с (${t.morning.commonDirection})</br>• ☀️ День: ${t.day.avgSpeed} м/с (${t.day.commonDirection})</br>• 🌇 Вечер: ${t.evening.avgSpeed} м/с (${t.evening.commonDirection})</br>`;return e&&(n+=`\n${e}`),n}buildSummary(t){const e=(t.morning.avgScore+t.day.avgScore+t.evening.avgScore)/3,n=["morning","day","evening"].reduce(((e,n)=>t[e].avgScore>t[n].avgScore?e:n));let i="";return i=e>=3.5?"<b>✔️ Отличные ветровые показатели для ловли леща!</b>\n":e>=2.5?`<b>✔️ Хорошие ветровые условия. Лучший период - ${this.translatePeriod(n)}</b>\n`:e>=2?"<b>⚠️ Умеренный клёв, выбирайте моменты с хорошим ветром</b>\n":e>=1.5?"<b>⚠️ Нестабильный клёв, выбирайте моменты с хорошим ветром</b>\n":"🔴 Неблагоприятные ветровые условия\n",i}buildHourlyDetails(t){const e={night:t.night.evaluations.map((t=>t.description)),morning:t.morning.evaluations.map((t=>t.description)),day:t.day.evaluations.map((t=>t.description)),evening:t.evening.evaluations.map((t=>t.description))};return this.groupPeriodDetails(e)}translatePeriod(t){return{morning:"утро",day:"день",evening:"вечер"}[t]}getWindStats(t,e){if(!t||0===t.length)return this.createEmptyStats();const n=t.map(((n,i)=>({...n,time:n.time||p.generateTimeForPeriod(i,t.length,e)}))),i=n.map(((t,e)=>{const i=n[e-1],r=n[e-2];return{time:t.time,evaluation:p.evaluateBreamWind(t.direction,t.speed,i?.direction,i?.speed,t.pressure,r?.pressure,t.speedDayTrue,t.time)}}));return{avgSpeed:p.calculateAvgSpeed(n),commonDirection:p.getDominantDirection(i.map((t=>t.evaluation))),avgScore:i.reduce(((t,{evaluation:e})=>t+e.score),0)/i.length,evaluations:i.map((t=>t.evaluation)),bestHour:{time:p.formatTimeBasic(p.findBestTimeEntry(i).time),evaluation:p.findBestTimeEntry(i).evaluation}}}createEmptyStats(){return{avgSpeed:"0.0",commonDirection:"Н/Д",avgScore:0,evaluations:[],bestHour:{time:"--:--",evaluation:{score:0,description:"Нет данных"}}}}describeWindEffect(t,e){const n=t.avgScore;let i,r,a;n>=3.5?(i="✔️",r="Отличные условия",a="Идеальные ветровые показатели для ловли леща!"):n>=2.5?(i="🎣",r="Хорошие условия",a="Перспективное время для рыбалки"):n>=1.5?(i="",r="Средние условия",a="Клёв возможен, но не гарантирован"):n>=1?(i="⚠️",r="Нестабильный клев",a="Клёв возможен, но не гарантирован"):(i="🚫",r="Плохие условия",a="Рекомендуется выбрать другое время");let s=`${i} ${e}: ${r}. ${a}\n<br>▸ Средняя скорость: ${t.avgSpeed} м/с - ${this.getSpeedDescription(t.avgSpeed)}<br>▸ Преобладающее направление: ${t.commonDirection} ${this.getDirectionDescription(t.commonDirection)}<br>`;if(t.bestHour&&"--:--"!==t.bestHour.time){const[e,...n]=t.bestHour.evaluation.description.split(" — ");s+=`\n▸ Лучшее время: ${t.bestHour.time} (${e} ${n.join(" ")})<br>`}return s}getSpeedDescription(t){const e=parseFloat(t);return e<=1?"штиль":e<=3?"оптимальная для клева":e<=6?"умеренная":"сильный ветер"}getDirectionDescription(t){return["Ю ↓","ЮЗ ↙","З ←"].includes(t)?"Благоприятное направление":["СЗ ↖","ЮВ ↘"].includes(t)?"Нейтральное направление":"Неблагоприятное направление"}mergeBadWindNotes(t){const e=[];let n=null,i=null,r=null;for(let a=0;a<t.length;a++){const s=t[a];if(s.processed)continue;if(!s.comment.startsWith("🚫")){e.push(s);continue}const o=s.comment.match(/\((.+?)\)/),c=o?o[1]:null;if(n){const t=parseInt(i.split(":")[0]);parseInt(s.time.split(":")[0])===t+1&&c===r?(i=s.time,s.processed=!0):(this.pushBlockNote(e,n,i,r),n=s.time,i=s.time,r=c,s.processed=!0)}else n=s.time,i=s.time,r=c,s.processed=!0}return n&&i&&this.pushBlockNote(e,n,i,r),t.filter((t=>!t.processed)).forEach((t=>e.push(t))),e}pushBlockNote(t,e,n,i){t.some((t=>t.time===`${e}–${n}`&&t.comment.includes(i||"Неблагоприятное направление ветра")))||(e===n?t.push({time:e,comment:i?`⚠️ Неблагоприятное направление ветра (${i}) может ухудшить клёв</br>`:"⚠️ Неблагоприятное направление ветра может ухудшить клёв</br>"}):t.push({time:`${e}–${n}`,comment:i?`⚠️ С ${e} до ${n} преобладал ветер ${i}, что могло негативно повлиять на клёв.</br>`:`⚠️ С ${e} до ${n} преобладал неблагоприятный ветер, что могло негативно повлиять на клёв.</br>`}))}groupPeriodDetails(t){const e={};for(const[n,i]of Object.entries(t)){if(!i||0===i.length)continue;const t=[];let r={text:i[0],start:0,end:0};for(let e=1;e<i.length;e++)i[e]===r.text?r.end=e:(t.push({...r}),r={text:i[e],start:e,end:e});t.push({...r}),e[n]=t.map((({start:t,end:e,text:r})=>`${p.generateTimeForPeriod(t,i.length,n)} – ${p.generateTimeForPeriod(e+1,i.length,n)} ${r}`))}return e}round(t,e=0){return parseFloat(t.toFixed(e))}}class D{constructor(t,e,n){this.season=t,this.t5=e,this.t1=n,this.seasonZones={spring:{min:4,optLow:7,optHigh:14,max:17},summer:{min:15,optLow:16,optHigh:22,max:26},autumn:{min:8,optLow:10,optHigh:17,max:20},winter:{min:-15,optLow:-3,optHigh:2,max:4}},this.timeAdjust={spring:{morning:1,day:0,evening:1},summer:{morning:2,day:-1,evening:1},autumn:{morning:1,day:1,evening:1},winter:{morning:0,day:-1,evening:0}}}getTemperatureScore(){const t=this.seasonZones[this.season];if(!t)return 0;const e=this.t5,n=this.t1,i=e=>e>=t.optLow&&e<=t.optHigh,r=e=>e>=t.min&&e<t.optLow||e>t.optHigh&&e<=t.max,a=i(e)?"opt":r(e)?"border":"bad",s=i(n)?"opt":r(n)?"border":"bad";return"opt"===a&&"opt"===s?2:"opt"===a&&"border"===s||"border"===a&&"opt"===s?1:"border"===a&&"border"===s?0:-1}getScoreByPeriod(t){let e=this.getTemperatureScore()+(this.timeAdjust[this.season]?.[t]??0);return Math.max(-1,Math.min(2,e))}getForecast(){return{morning:this.getScoreByPeriod("morning"),day:this.getScoreByPeriod("day"),evening:this.getScoreByPeriod("evening")}}}class b{constructor(){}calculate(t,e){const n=p.getSeason(e),i=t.find((t=>t.date===e)),r=i?i.temp:null,a=new Date(e),s=t.filter((t=>new Date(t.date)<a)).slice(-5);if(s.length<5)return"Недостаточно данных";const o=this.round(s.reduce(((t,e)=>t+e.precipitations),0),1),c=this.round(s.reduce(((t,e)=>t+e.temp),0)/5);let l=0,d="";if(r){const t=Math.abs(r-c);t>5&&(l=-1,d=` ⚠️ Резкий перепад температуры (${t}°C)`),t>10&&(l=-2,d=` 🚫 Опасный перепад температуры (${t}°C)`)}let h=0,u="";"summer"===n||"spring"===n?o>30&&"summer"===n?(h=-2,u="🚫 Прекращение клева. Сильный смыв грунта и органики, образование мути на течении. Лещ уходит в глубинные ямы (7+ м) и перестает кормиться 2-3 дня."):o>40&&"spring"===n?(h=-2,u="🚫 Паводковый сброс - лещ концентрируется на нерестилищах, клёв прекращается"):o>15?c>=16&&c<=22?(h=2,u="✔️ Клёв активный. Обильные дожди привели к сбросу воды с водохранилища, усилилось течение. Прикормка распространяется, кислород в воде повышается, температура в оптимальном диапазоне — лещ активно кормится"):(h=1,u=`Осадков достаточно, но температура воздуха ${c}°C выходит за пределы комфортного диапазона. Возможны кратковременные ухудшения активности рыбы.`):o>5?c>=16&&c<=22?(h=1,u="👍 Умеренные дожди способствуют мягкому сбросу воды, течение умеренное. Это усиливает подвижность леща, особенно при стабильной температуре."):(h=0,u=`➖ Нейтрально: Осадки есть, но средняя температура ${c}°C не оптимальна для метаболической активности леща.`):(h=-1,u="⚠️ Клёв ослабевает. Отсутствие дождей приводит к снижению уровня воды, течение слабое или отсутствует. В жаркую погоду вода беднеет кислородом, рыба становится вялой и отходит в глубину."):"autumn"===n?c>=8&&c<=14?(h=Math.max(h,2),u="✔️ Предзимний жор! Лещ активно питается независимо от осадков"):c>14&&c<=20?o>40?(h=-2,u="🚫 Чрезмерные осадки (40+ мм). Вода сильно мутная, возможны сбросы — клёв срывается на несколько дней."):o>30?(h=-1.5,u="⚠️ Осадков много (30–50 мм). Вода мутная, течение резкое, клёв ослаблен."):o>5?(h=1,u="👍 Умеренные осадки и комфортная температура — клёв устойчивый."):(h=0,u="⚠️ Осадков мало, течение слабое. Клёв средний или нестабильный."):(h=-1,u=`⚠️ Температура ${c}°C и осадки ${o} мм не создают благоприятных условий.`):(h=0,u=null),-2===h&&-2===l?h=-2:(h+=.5*l,h=Math.max(Math.min(h,2),-2));const m=`💧 Осадки за 5 дней: ${o} мм <br>Средняя температура за 5 дней: ${c}°C <br>🎣 Влияние осадков и температуры: ${u} ${d}<br>`;this.result={date:e,details:{morning:[],day:[],evening:[]},weights:{general:h,model:"precipitations"},general:m}}getResult(){return this.result}round(t,e=0){return parseFloat(t.toFixed(e))}getModelType(){return"precipitations"}}class S{constructor(){this.result={}}calculate(e,n){const i=p.getSeason(n),r=p.calculate(e),a={morning:[],day:[],evening:[]},s=[],o=[],c=[];this.impactsWeights=[];for(const[n,l]of Object.entries(r))if("night"!==n&&a[n])for(const r of l){const l=r.time?.slice(11,16)||"00:00",d=t.getWeatherType(r),h=t.getWeatherDescription(r),u=this.getImpact(d,i,n,e);if(u?this.impactsWeights.push(u.weight):this.impactsWeights.push(0),!u)continue;const m=`${l} ${u.emoji} ${h} — ${u.comment}`;a[n].push(m),c.push({type:u.type,weight:u.weight,comment:u.comment}),u.weight>0?s.push(u.weight):u.weight<0&&o.push(u.weight)}for(const t in a)a[t]=this.groupConsecutiveNotes(a[t]);const l=this.getGeneralConclusion(s,o,i,c);this.result={general:l,details:a,date:n,weights:this.getWeightsObject()}}getWeightsObject(){const t=this.impactsWeights||[],e=t.slice(0,t.length/3),n=t.slice(t.length/3,2*t.length/3),i=t.slice(2*t.length/3),r=t=>t.length?t.reduce(((t,e)=>t+e),0)/t.length:0;return{general:this.round(r(t)),morning:this.round(r(e)),day:this.round(r(n)),evening:this.round(r(i)),model:this.getModelType()}}round(t,e=1){return parseFloat(t.toFixed(e))}getModelType(){throw new Error("Метод getModelType должен быть реализован в наследуемом классе")}groupConsecutiveNotes(t){if(!t.length)return[];const e=[];let n=null;for(const i of t){const t=i.match(/^(\d{2}:\d{2}) (.+?) — (.+)$/);if(!t)continue;const[r,a,s,o]=t;n&&n.weatherType===s&&n.comment===o?n.endTime=a:(n&&e.push(this.formatNote(n)),n={startTime:a,endTime:a,weatherType:s,comment:o})}return n&&e.push(this.formatNote(n)),e}formatNote({startTime:t,endTime:e,weatherType:n,comment:i}){return`${t===e?t:`${t} – ${e}`} ${n} — ${i}`}getGeneralConclusion(t,e,n,i=[]){if(!i.length)return"";const r=this.groupImpactsByType(i),a=[];for(const[t,e]of Object.entries(r)){const n=this.getIconForType(t),i=[...new Set(e.map((t=>t.comment)))].map((t=>`— ${t}`));a.push(`${n} ${t}:</br>${i.join("</br>")}`)}let s="";const o=t.reduce(((t,e)=>t+e),0),c=e.reduce(((t,e)=>t+e),0);return s=o>Math.abs(c)?this.getSeasonPositivePhrase(n):Math.abs(c)>o?this.getSeasonNegativePhrase(n):this.getMixedImpactPhrase(n),a.length>0?[...a,`📊 В целом: ${s}`].join("\n\n"):""}getPositivePhrase(t){return"благоприятна для клёва"}getNegativePhrase(t){return"снижает клёв"}getNeutralPhrase(t){return"не оказывает заметного влияния"}getSeasonPositivePhrase(t){return"Условия способствуют активному клёву в течение дня"}getSeasonNegativePhrase(t){return"Общие погодные условия снижают активность рыбы"}getMixedImpactPhrase(t){return"Погода переменчива — возможны периоды активности и затишья"}getIconForType(t){return{Ясно:"☀️","Преимущественно ясно":"☀️","Переменная облачность":"⛅",Облачно:"☁️",Пасмурно:"☁️",Туман:" 🌁",Морось:"☔","Морось: слабая":"☔","Морось: умеренная":"☔","Морось: сильная":"☔","Ледяная морось: слабая":"❄️","Ледяная морось: сильная":"❄️","Дождь: слабый":"⛈️","Дождь: умеренный":"⛈️","Дождь: сильный":"⛈️","Ледяной дождь: слабый":"❄️","Ледяной дождь: сильный":"❄️","Снег: слабый":"❄️","Снег: умеренный":"❄️","Снег: сильный":"❄️","Снежные зерна":"❄️","Снегопад: слабый":"❄️","Снегопад: сильный":"❄️","Ливень: слабый":"⛈️","Ливень: умеренный":"⛈️","Ливень: сильный":"⛈️","Гроза: слабая":"⛈️","Гроза с градом: слабая":"⛈️"}[t]||""}getImpact(t,e,n,i){throw new Error("Метод getImpact должен быть реализован в наследуемом классе")}groupImpactsByType(t){const e={};for(const n of t)e[n.type]||(e[n.type]=[]),e[n.type].push(n);return e}getResult(){return this.result}}class C extends S{getImpact(t,e,n){const i=["Ясно","Преимущественно ясно","Ясная погода"].includes(t),r=["Облачно","Пасмурно","Преимущественно облачно","Переменная облачность"].includes(t);if("summer"===e){if("morning"===n){if(i)return{type:"Ясная погода",weight:1,comment:"✔️ Утреннее солнце - хороший клёв до наступления жары<br>",emoji:"🌅"};if("Переменная облачность"===t)return{type:"Переменная облачность",weight:2,comment:"✔️ Идеальные условия для утренней ловли<br>",emoji:"⛅"}}if("day"===n){if(i)return{type:"Ясная погода",weight:-2,comment:"⚠️ Сильная жара - клёв только на глубине<br>",emoji:"🔥"};if("Переменная облачность"===t)return{type:"Переменная облачность",weight:1,comment:"✔️ Облачность смягчает жару - рыба активна<br>",emoji:"⛅"};if("Пасмурно"===t)return{type:"Пасмурно",weight:2,comment:"✔️ Лучшие условия для дневной ловли летом<br>",emoji:"☁️"}}if("evening"===n){if(r)return{type:"Облачная погода",weight:2,comment:"✔️ Пасмурный вечер - пик клёва<br>",emoji:"🌆"};if("Переменная облачность"===t)return{type:"Переменная облачность",weight:1,comment:"✔️ Хорошие перспективы для вечерней рыбалки<br>",emoji:"⛅"}}}if("spring"===e){if("morning"===n){if(i)return{type:"Ясная погода",weight:2,comment:"✔️ Солнечное утро - активный клёв на прогретых участках<br>",emoji:"☀️"};if("Переменная облачность"===t)return{type:"Переменная облачность",weight:1,comment:"✔️ Умеренная активность рыбы<br>",emoji:"⛅"}}if("day"===n){if(r)return{type:"Облачная погода",weight:-1,comment:"➖ Холодная облачность замедляет прогрев воды<br>",emoji:"☁️"};if("Переменная облачность"===t)return{type:"Переменная облачность",weight:1,comment:"✔️ Благоприятные условия для ловли<br>",emoji:"⛅"}}if("evening"===n){if("Переменная облачность"===t)return{type:"Переменная облачность",weight:2,comment:"✔️ Идеальное время для весенней рыбалки<br>",emoji:"🌇"};if(i)return{type:"Ясная погода",weight:1,comment:"✔️ Тёплый вечер - хороший клёв<br>",emoji:"☀️"}}}if("autumn"===e){if(r){if("morning"===n)return{type:"Облачная погода",weight:2,comment:"✔️ Пасмурное утро - лучший клёв осенью<br>",emoji:"☁️"};if("day"===n)return{type:"Облачная погода",weight:2,comment:"✔️ Облачный день - рыба активно питается<br>",emoji:"☁️"};if("evening"===n)return{type:"Облачная погода",weight:1,comment:"✔️ Хорошие условия для вечерней ловли<br>",emoji:"☁️"}}if("Переменная облачность"===t&&"day"!==n)return{type:"Переменная облачность",weight:1,comment:"✔️ Нестабильная погода - средний клёв<br>",emoji:"⛅"}}if("winter"===e){if(r)return"day"===n?{type:"Облачная погода",weight:2,comment:"✔️ Пасмурный день - лучшие условия для зимней ловли<br>",emoji:"☁️"}:{type:"Облачная погода",weight:1,comment:"✔️ Облачность поддерживает стабильный клёв<br>",emoji:"☁️"};if(i)return"day"===n?{type:"Ясная погода",weight:-1,comment:"➖ Ясный день - рыба пассивна<br>",emoji:"☀️"}:{type:"Ясная погода",weight:-2,comment:"⚠️ Ясная морозная погода - клёв отсутствует<br>",emoji:"❄️"}}return null}getModelType(){return"cloudy"}getSeasonPositivePhrase(t){switch(t){case"summer":return"<b>✔️ Облачная погода снижает жару — отличные условия для клёва</b>";case"spring":return"<b>✔️ Солнечные утренние часы прогревают воду — клёв активный</b>";case"autumn":return"<b>✔️ Пасмурная осень — стабильный клёв в течение дня</b>";case"winter":return"<b>✔️ Пасмурная погода — оптимальные условия для зимней рыбалки</b>";default:return"<b>✔️ Условия способствуют активному клёву в течение дня</b>"}}getSeasonNegativePhrase(t){switch(t){case"summer":return"<b>⚠️ Жаркая ясная погода снижает клёв — лучше рыбачить утром или вечером</b>";case"spring":return"<b>⚠️ Плотная облачность весной замедляет прогрев воды — клёв ухудшается</b>";case"autumn":return"<b>⚠️ Чрезмерная облачность может понизить активность рыбы</b>";case"winter":return"<b>⚠️ Ясные морозные дни ухудшают клёв — пасмурная погода предпочтительнее</b>";default:return"<b>⚠️ Неблагоприятные погодные условия — клюёт хуже</b>"}}}class T extends S{constructor(){super(),this.rainState={isRaining:!1,duration:0,lastType:null,previousHourWasRain:!1,totalRainDuration:0}}getModelType(){return"rain"}calculate(e,n){const[i,r]=e;this.rainState.totalRainDuration=0,this.postRainArr=[];const a=new Date(n),s=r.filter((t=>new Date(t.date)<a)).slice(-5),o=s.slice(-3).filter((t=>t.temp>25&&0===t.precipitations)).length,c=this.round(s.reduce(((t,e)=>t+e.temp),0)/5),l=s.filter((t=>0===t.precipitations)).length;this.environmentContext={avgTemp:c,dryDaysCount:l,wasHeatWave:3===o,lastRainDays:s.filter((t=>t.precipitations>0)).length};const d=p.getSeason(n),h=p.calculate(i),u={morning:[],day:[],evening:[]},m=[],g=[],y=[];this.impactsWeights=[];for(const[e,n]of Object.entries(h))if("night"!==e&&u[e])for(const i of n){const n=i.time?.slice(11,16)||"00:00",r=t.getWeatherType(i);let a=this.getImpact(r,d,e,n);if(a?this.impactsWeights.push(a.weight):this.impactsWeights.push(0),!a)continue;const s=t.getWeatherDescription(i)||a.description||"Без описания",o=`${n} ${a.emoji} ${s} — ${a.comment}`;u[e].push(o),y.push({type:a.type,weight:a.weight,comment:a.comment}),a.weight>0?m.push(a.weight):a.weight<0&&g.push(a.weight)}for(const t in u)u[t]=this.groupConsecutiveNotes(u[t]);const w=this.getGeneralConclusion(m,g,d,y);this.applyPostRainRecovery(),this.result={general:w,details:u,date:n,weights:this.getWeightsObject()}}groupConsecutiveNotes(t){if(!t.length)return[];const e=[];let n=null;for(const i of t){const t=i.match(/^(\d{2}:\d{2}) (.+?) — (.+)$/);if(!t)continue;const[r,a,s,o]=t;n&&n.weatherType===s&&n.comment===o?n.endTime=a:(n&&e.push(this.formatNote(n)),n={startTime:a,endTime:a,weatherType:s,comment:o})}return n&&e.push(this.formatNote(n)),e}getImpact(t,e,n,i){const r=this.getRainIntensity(t);this.updateRainState(t,r);let a=null;return r?a=this.getCurrentRainImpact(t,e,r):this.rainState.previousHourWasRain&&(a=this.getPostRainImpact(e,i)),a&&"После дождя"===a.type&&(a.description=" После дождя"),a}getRainIntensity(t){return t?t.includes("Морось")?t.includes("сильная")?"HEAVY":"LIGHT":t.includes("Дождь")?t.includes("слабый")?"LIGHT":"MEDIUM":t.includes("Ливень")||t.includes("Гроза")?"HEAVY":null:null}updateRainState(t,e){e?(this.rainState.isRaining&&t===this.rainState.lastType?this.rainState.duration++:this.rainState.duration=1,this.rainState.totalRainDuration=(this.rainState.totalRainDuration||0)+1,this.rainState.isRaining=!0,this.rainState.lastType=t,this.rainState.lastRainType=t,this.rainState.previousHourWasRain=!0):(this.rainState.previousHourWasRain=this.rainState.isRaining,this.rainState.isRaining=!1,this.rainState.duration=0,this.rainState.lastType=null)}getCurrentRainImpact(t,e,n){const i=this.isProlongedRain(n),r=this.getBaseRainEffect(n,e);return i?{...r,weight:r.weight*("HEAVY"===n?1.8:1.5),comment:`${r.comment} ${this.getProlongedEffect(e)}`,isProlonged:!0}:r}isProlongedRain(t){return this.rainState.duration>={LIGHT:5,MEDIUM:4,HEAVY:3}[t]}getBaseRainEffect(t,e){return{LIGHT:{type:"\n⛈️ Осадки",weight:this.getDynamicWeight(1.2,e),comment:this.getLightRainComment(e),emoji:"☔"},MEDIUM:{type:"\n⛈️ Осадки",weight:-.8,comment:this.getMediumRainComment(e),emoji:"⛈️"},HEAVY:{type:"\n⛈️ Осадки",weight:-1.5,comment:this.getHeavyRainComment(e),emoji:"⛈️"}}[t]}getDynamicWeight(t,e){let n=t;return this.environmentContext?(this.environmentContext.avgTemp>24&&(n*=1.2,this.environmentContext.wasHeatWave&&(n*=1.2)),this.environmentContext.avgTemp<16&&(n*=.8),this.environmentContext.lastRainDays>0&&(n*=Math.max(.8,1-.08*this.environmentContext.lastRainDays)),this.round(n,2)):n}getPostRainImpact(t,e){if(!this.rainState.previousHourWasRain)return null;const n=this.calculateRecoveryTime(t),i=n>0,r=this.getDepthChange(t),a=this.calculateEffectWeight(t),s=this.rainState.duration<=1?this.buildRainComment(t,n,r):null,o=this.round(n,0),c={hour:e,recoveryTimeCalc:o,weightAfterRain:this.round(a,2)};return this.postRainArr.push(c),{type:"<br>🌈 После дождя "+(i?"⚠️":"✔️"),weight:0,comment:s,emoji:"🌈",recoveryTime:o,depthChange:r}}applyPostRainRecovery(){this.postRainArr.forEach((({hour:t,recoveryTimeCalc:e,weightAfterRain:n})=>{const[i]=t.split(":");let r=parseInt(i,10)-6,a=r+e;if(a<0||r>17)return;for(let t=r;t<a;t++)t>=0&&t<18&&(this.impactsWeights[t]=-1.5);let s=a,o=Math.min(s+8,18);for(let t=s;t<o&&t<18&&!(this.impactsWeights[t]<0);t++)this.impactsWeights[t]=1.2*n}))}calculateEffectWeight(t){let e=this.getBaseWeightForSeason(t);return this.environmentContext?(this.environmentContext.wasHeatWave?e+=1.2:this.environmentContext.avgTemp>24&&(e+=.7),e-=.3*(this.environmentContext.lastRainDays||0),e):e}buildRainComment(t,e,n){const i=[this.getPostRainComment(t)];return this.environmentContext&&(this.environmentContext.wasHeatWave?i.push("После 3 дней жары рыба особенно активна после дождя"):this.environmentContext.avgTemp>24&&i.push("Высокая температура усиливает реакцию на дождь")),e>0&&i.push(`Клев восстановится через ~${this.round(e,0)} ч.`),0!==n&&i.push(n>0?`Ищите рыбу на ${n} м глубже обычного.`:`Попробуйте места на ${Math.abs(n)} м мельче привычных.`),i.join(" ")}getBaseWeightForSeason(t){return{summer:2,spring:1.2,autumn:1,winter:.5}[t]||1}calculateRecoveryTime(t){const e=this.rainState.totalRainDuration||0;if(0===e)return 0;let n=Math.min(6,e/2)*{summer:.7,spring:1,autumn:.9,winter:1.5}[t]*((this.rainState.lastRainType||"").includes("Ливень")?1.3:1);return this.environmentContext&&(this.environmentContext.avgTemp>24&&(n*=.7),this.environmentContext.avgTemp<16&&(n*=1.2)),this.round(n,1)}getDepthChange(t){return this.rainState.totalRainDuration<2?0:{summer:1.5,spring:-.5,autumn:.7,winter:0}[t]}getProlongedEffect(t){switch(t){case"summer":return"(Затяжной дождь летом снижает активность рыбы на 40%)";case"spring":return"(Продолжительные осадки весной могут изменить маршруты миграции)";default:return"(Длительное воздействие осадков)"}}getPostRainWeight(t){let e={summer:2.2,spring:1.5,autumn:1.3,winter:.5}[t];return this.environmentContext&&(this.environmentContext.avgTemp>24&&(e+=.8,this.environmentContext.wasHeatWave&&(e+=.5)),this.environmentContext.dryDaysCount>=3&&(e+=.5)),this.round(e,1)}getPostRainComment(t){switch(t){case"summer":return"✔️ После летнего дождя вода насыщена кислородом - идеальное время для ловли!";case"spring":return"✔️ Весенний дождь вымыл корм - рыба активно питается";case"autumn":return"✔️ После осеннего дождя отмечается всплеск активности рыбы";default:return"✔️ Рыба возобновляет активность после дождя"}}getLightRainComment(t){switch(t){case"summer":return"✔️ Лёгкий летний дождь охлаждает воду и улучшает клёв. Идеальные условия через 30-60 мин после начала";case"spring":return"✔️ Мелкие осадки весной не отпугивают рыбу — клёв возможен. Смывает в воду дождевых червей, личинок";case"autumn":return"✔️ Слабый дождь осенью не мешает клёву";case"winter":return"✔️ Если нет мороза, слабые осадки зимой не мешают рыбалке";default:return"✔️ Осадки не мешают клёву"}}getMediumRainComment(t){switch(t){case"summer":return"⚠️ Умеренный летний дождь временно снижает активность рыбы. Первые 20-30 минут возможен всплеск клева, затем пауза 1-2 часа. Лещ смещается на 0.5-1 м глубже от привычных стоянок.";case"spring":return"⚠️ Весенний дождь средней силы создает нестабильные условия. Клев возможен в местах впадения ручьев, где вымывается корм. Используйте подвижные приманки (опарыш на движущейся оснастке).";case"autumn":return"⚠️ Осенний дождь охлаждает воду, замедляя метаболизм рыбы. Эффективна ловля вполводы с медленной проводкой. Оптимально через 1 час после начала дождя.";case"winter":return"⚠️ Дождь зимой - редкое явление, обычно при оттепели. Рыба может кратковременно активизироваться у кромки льда. Используйте мелкие мормышки с мотылем.";default:return"⚠️ Умеренные осадки создают переменные условия для ловли. Рекомендуется экспериментировать с глубиной и приманками."}}getHeavyRainComment(t){switch(t){case"summer":return"⚠️ Сильный дождь летом вызывает помутнение воды и снижает клёв. Начало дождя: кратковременный всплеск клева (20-40 мин).";case"spring":return"⚠️ Весенний ливень может испугать рыбу — клёв ухудшается. Лещ при сильном дожде смещается к прибрежным бровкам";case"autumn":return"⚠️ Продолжительный дождь осенью ухудшает клёв и делает рыбалку затруднительной";case"winter":return"⚠️ Дождь зимой часто сопровождается оттепелью и нестабильностью — клёв ухудшается";default:return"⚠️ Сильные осадки негативно сказываются на клёве"}}getSeasonPositivePhrase(t){switch(t){case"summer":return"<br>✔️ Лёгкие летние дожди благоприятны для клёва, особенно после жарких периодов";case"spring":return"<br>✔️ Весенние дожди вымывают корм, привлекая рыбу к берегу";case"autumn":return"<br>✔️ Осенние моросящие дожди поддерживают активность рыбы";case"winter":return"<br>✔️ Слабые осадки зимой могут активизировать рыбу во время оттепели";default:return"<br>✔️ Умеренные осадки создают хорошие условия для ловли"}}getSeasonNegativePhrase(t){switch(t){case"summer":return"⚠️ Сильные ливни летом резко ухудшают клёв из-за помутнения воды";case"spring":return"⚠️ Затяжные весенние дожди приводят к подъёму воды и ухудшению условий";case"autumn":return"⚠️ Холодные осенние дожди снижают активность рыбы перед зимовкой";case"winter":return"⚠️ Дождь со снегом создаёт нестабильные условия для зимней рыбалки";default:return"⚠️ Сильные осадки негативно влияют на активность рыбы"}}round(t,e=0){return parseFloat(t.toFixed(e))}}class M extends S{constructor(){super()}calculate(t,e){const n=p.getSeason(e),i=p.calculate(t)||null,r=this.getPressureStats(t),a=this.getDailyFishingAnalysis(r,t),s={morning:[],day:[],evening:[]},o=[],c={night:this.getPressureStats(i.night||[]),morning:this.getPressureStats(i.morning||[]),day:this.getPressureStats(i.day||[]),evening:this.getPressureStats(i.evening||[])},l={morning:this.getImpact(c.morning,"morning",n,c.night),day:this.getImpact(c.day,"day",n,c.night,c.morning),evening:this.getImpact(c.evening,"evening",n,c.night,c.morning,c.day)};for(const[t,e]of Object.entries(l)){if(!e)continue;const n=this.getPressureTrendDescription(c[t]),i=`${e.timeRange} ${e.emoji} <b>📉 Атмосферное давление:</b> ${n} — ${e.comment}`;s[t].push(i),o.push({type:"📈 Атмосферное давление",weight:e.weight,comment:e.comment})}const d=this.getGeneralConclusion(a),h={general:a.weight,morning:l.morning.weight,day:l.day.weight,evening:l.evening.weight,model:"pressure"};this.result={general:`\n\n${d}`,details:s,date:e,weights:h}}getModelType(){return"pressure"}getImpact(t,e,n,i=null,r=null,a=null){const s=this.getTimeRangeForPeriod(e);let o=this.getBaseImpact(t);o=this.applySeasonalAdjustments(o,t,n,e),"morning"===e?this.analyzePressureBeforeMorning(o,t,i):"day"===e?this.analyzePressureBeforeDay(o,t,i,r,n):"evening"===e&&this.analyzePressureBeforeEvening(o,t,i,r,a,n);const c=this.getScoreEmoji(o.weight);return{...o,emoji:c,timeRange:s}}analyzePressureBeforeMorning(t,e,n){const{avg:i,min:r,max:a,delta:s,startValue:o,endValue:c,trend:l}=e,{avg:d,min:h,max:u,delta:m,startValue:g,endValue:p,trend:y}=n;t.comment+="<br>📈 Влияния ночного давления: ",y<-2?(t.weight=-3,t.comment+=`<br>🚫 Резкое ночное падение давления ${this.getTrendPrint(y)} мм — клёв отсутствует (стресс)`):-2===y?l>=1?(i>=740&&i<755&&(t.weight=2===t.weight?2:t.weight-1),t.comment+=`<br>⚠️ Рост давления утром ${this.getTrendPrint(l)} мм после падения ночью (${this.getTrendPrint(y)} мм)  — возможен кратковременный клёв`):l<-1?(t.weight=-3,t.comment+=`<br>🚫 Давление продолжает падать ${this.getTrendPrint(l)} мм — рыба в стрессе`):0===l&&(t.weight=-3===t.weight?-3:t.weight-1,t.comment+=`<br>⚠️ Давление стабилизировалось после падения ночью (${this.getTrendPrint(y)} мм) — клёв слабый, но возможен вечером`):y>=2?i>=740&&i<755?l>=0?(t.comment+="<br>✔️ Ночной рост давления — хорошие условия для ловли",t.weight=Math.min(t.weight+1,2)):(t.comment+=`<br>⚠️ После роста ночью ${this.getTrendPrint(y)} мм давление начало падать ${this.getTrendPrint(l)} мм — активность снижается`,t.weight=-3===t.weight?-3:t.weight-1):t.comment+=l>=0?"<br>⚠️ Ночной рост давления — способствует устойчивому поведению рыбы.":`<br>⚠️ После роста ночью ${this.getTrendPrint(y)} мм давление начало падать ${this.getTrendPrint(l)} мм — активность снижается`:Math.abs(y)<=1&&(t.comment+=i>=740&&i<755?`<br>✔️ Ночью давление стабильно (${g} → ${p} мм) ( ${this.getTrendPrint(y)} мм.) — рыба активна`:`<br>⚠️ Ночью давление стабильно (${g} → ${p} мм) ${this.getTrendPrint(y)} мм. — способствует устойчивому поведению рыбы.`)}analyzePressureBeforeDay(t,e,n,i,r){const{avg:a,min:s,max:o,delta:c,startValue:l,endValue:d,trend:h}=e,{avg:u,min:m,max:g,delta:p,startValue:y,endValue:w,trend:v}=n,{avg:f,min:$,max:D,delta:b,startValue:S,endValue:C,trend:T}=i,M=C-w,P=v>0&&T<0||v<0&&T>0;if(t.comment+="<br>📈 Влияния давления в предыдущем периоде: ",M<=-2?t.comment+=`<br>⚠️ Давление снизилось по сравнению с предыдущим периодом ${y}мм → ${C}мм  ${this.getTrendPrint(M)} мм.`:M>=2?t.comment+=`<br>⚠️ Давление повысилось по сравнению с предыдущим периодом ${y}мм → ${C}мм  ${this.getTrendPrint(M)} мм.`:Math.abs(M)<=1&&(t.comment+=`<br>✔️ Давление в предыдущем периоде было стабильным ${y}мм → ${C}мм  ${this.getTrendPrint(M)} мм.`),M<=-4)t.comment+=`<br>🌀 <b>КОЛЛАПС</b>: Суточное падение ${this.getTrendPrint(M)} мм (ночь ${this.getTrendPrint(v)} мм, утро ${this.getTrendPrint(T)})`,T>0&&h>=2?(t.weight=Math.min(t.weight,-1),t.comment+=`<br>⚠️ Утренний и дневной рост ${this.getTrendPrint(T+h)} мм сглаживают негатив — возможна активизация после 16:00`):(t.weight=-3,t.comment+=`<br>⛔ Давление падало всю ночь и утро ${this.getTrendPrint(v+T)} — лещ уходит в яму и может полностью перестать кормиться`);else if(M>=5){const e=Math.abs(v)<=2&&T<=2;b<=2&&e?(t.weight=Math.min(t.weight+1,2),t.comment+=`<br>📈 Устойчивый рост ${this.getTrendPrint(M)} мм — отличные условия для дневного клёва (13:00–15:30)`):(t.weight=-3===t.weight?-3:t.weight-1,t.comment+=`<br>⚠️ Перенасыщение: слишком быстрый рост давления ${this.getTrendPrint(v+T)} — возможна настороженность рыбы`)}else P?v>2&&T<-2?(t.weight=-3,t.comment+=`<br>🚫 Критический разворот давления: ночь (${this.getTrendPrint(v)} мм) → утро (${this.getTrendPrint(T)} мм)  — дезориентация`):v<-3&&T>2&&(t.weight=Math.max(t.weight,0),t.comment+=`<br>⚠️ Частичное восстановление после падения ночь (${this.getTrendPrint(v)} мм) → утро (${this.getTrendPrint(T)} мм) — возможен клёв во второй половине дня`):M>-4&&M<=-3?(t.weight=-3===t.weight?-3:t.weight-1,t.comment+=`<br>↘️ Компенсационный режим  ночь  ${this.getTrendPrint(v)} → утро ${this.getTrendPrint(T)} — ищите на глубине 6–8 м`,T>=1&&(t.weight=0,t.comment+=`<br>⚡ Утренний рост  ${this.getTrendPrint(T)} мм частично компенсирует ночной спад  ${this.getTrendPrint(v)}`)):M>=3&&M<5?T>=1&&h>=0&&b<=2?(t.weight=Math.min(t.weight+1,2),t.comment+=`<br>⤴️ Постепенный дневной подъём давления ${this.getTrendPrint(h)} мм — вероятны поклёвки после 13:00`):(t.weight=Math.min(t.weight,0),t.comment+="<br>⚠️ Давление растёт, но нестабильно — активность может быть прерывистой"):b<=2&&Math.abs(T)<=1&&(v>=2||Math.abs(v)<=1)&&(v>=2?(t.weight=Math.min(t.weight+1,2),t.comment+=`<br>📊 После ночного подъёма (${this.getTrendPrint(v)} мм) давление стабилизировалось утром (${f} мм) — возможна активизация клёва после 13:00`):a>=740&&a<750?(t.comment+=`<br>✔️ Ночь и утро были стабильны (${y} → ${C} мм) — возможен уверенный клёв`,t.weight=Math.min(t.weight+1,2)):t.comment+=`<br>⚠️ Давление стабильное (${y} → ${C} мм), но уровень ${f} мм может ограничить активность`);const x=M<=-4?"8–10 м (русловые ямы)":h>=2&&a<=750?"4–5 м (бровки)":a>=755?"глубже 6–7 м (высокое давление)":"5–7 м (перепады глубин)";t.comment+=`<br>🎣 Оптимальные глубины: ${x}`,"winter"===r&&Math.abs(M)>=2?(t.weight=Math.max(t.weight-1,-3),t.comment+="<br>❄️ Зимой лещ крайне чувствителен к перепадам — риск ухода в пассив"):"summer"===r&&a>755&&(t.comment+="<br>☀️ Жаркое лето: ищите термоклин на глубинах 5–6 м — лещ может там задерживаться",t.weight=Math.min(t.weight,0)),a>=742&&a<=748&&b<=3&&(t.comment+=`<br>✔️ Давление в идеальном диапазоне для Днепра ${f} - ${a} мм — возможна дневная кормёжка на средних глубинах`,t.weight=Math.min(t.weight+1,2))}analyzePressureBeforeEvening(t,e,n,i,r,a){const{avg:s,min:o,max:c,delta:l,startValue:d,endValue:h,trend:u}=e,{avg:m,delta:g,endValue:p,trend:y}=i,{avg:w,delta:v,endValue:f,trend:$}=r,{avg:D,delta:b,endValue:S,trend:C}=n,T=C+y+$,M=C>2&&y<-2||y>2&&$<-2,P=Math.abs(C)<=1&&Math.abs(y)<=1&&Math.abs($)<=1;t.comment+=`<br>📊 Давление за предыдущий период: ночь ${this.getTrendPrint(C)}, утро ${this.getTrendPrint(y)}, день ${this.getTrendPrint($)} → суммарно: ${this.getTrendPrint(T)} мм`,T<=-5?(t.weight=-3,t.comment+="<br>❌ Экстремальный суточный спад — полная пассивность рыбы"):M?(t.weight=Math.min(t.weight,-2),t.comment+="<br>⛔ Критический разворот давления — рыба дезориентирована"):C<=-3&&y<=-2&&$<=-1?(t.weight=-3,t.comment+="<br>❌ Суточное падение давления — лещ в глубоких ямах"):P&&w>=740&&w<=750?(t.weight=Math.min(t.weight+1,2),t.comment+="<br>✔️ Идеальная стабильность — лучший вечерний клёв"):T>=3&&T<5&&$>=1?(t.weight=Math.min(t.weight+1,1),t.comment+="<br>📈 Плавный суточный рост — хорошие перспективы"):C<=-2&&y>=1&&$>=2?(t.weight=Math.min(t.weight,0),t.comment+="<br>⚠️ Компенсация давления — клёв возможен после 20:00"):C>=2&&y>=2&&$<=-2?(t.weight=-3===t.weight?-3:t.weight-1,t.comment+="<br>⚠️ Разворот (рост→падение) — кратковременный клёв"):C<=-2&&y<=-1&&$>=2?(t.weight=Math.min(t.weight,0),t.comment+="<br>⚠️ Стабилизация — восстановление к позднему вечеру"):C<=-2&&y>=2&&$<=-2?(t.weight=Math.min(t.weight,-1),t.comment+="<br>⚠️ Пиловидный профиль — краткие всплески активности"):C>=2&&y<=-2&&$>=2?(t.weight=Math.min(t.weight,0),t.comment+="<br>⚠️ Зигзагообразные изменения — непредсказуемый клёв"):P&&$<=-2?(t.weight=Math.min(t.weight,0),t.comment+="<br>⚠️ Стабильность→падение — клёв до 20:00"):T>=4?(t.weight=2===t.weight?2:t.weight+1,t.comment+="<br>📈 Общий рост — постепенное усиление клёва"):T>=6?(t.weight=Math.min(t.weight,-2),t.comment+="<br>⛔ Сверхрост — рыба насторожена"):T<=-4?(t.weight=-2,t.comment+=`<br>ℹ️ Умеренные изменения (↓ Δ${Math.abs(T)}) — активность снижена`):(t.weight=Math.min(t.weight,0),t.comment+="<br>ℹ️ Умеренные изменения — активность точечная");const x=T<=-4?"7–10 м (ямы)":T>=3&&T<5?"4–5 м (поливы)":$>=2?"4–6 м (бровки)":w>=755?"6–8 м (термоклин)":"5–7 м (стандартные глубины)";t.comment+=`<br>🎣 Оптимальные глубины: ${x}`,"winter"===a?Math.abs(T)>=3&&(t.weight=Math.max(t.weight-1,-3),t.comment+="<br>❄️ Зимняя чувствительность — используйте прикорм"):"summer"===a&&w>=755&&(t.comment+="<br>☀️ Летняя жара — ищите тенистые участки"),w>=753&&w<=755&&T<=1&&(t.comment+="<br>ℹ️ Высокое, но стабильное давление — пробуйте разные глубины")}getGeneralConclusion(t){const{weight:e,comment:n}=t;let i=`\n\n ${this.getScoreEmoji(e)} <b>📉 Анализ давления за день:</b> \n`;return i+=`\n${n}\n`,i+=e>0?this.getPositivePhrase(e):e<0?this.getNegativePhrase(e):this.getNeutralPhrase(e),i}getScoreEmoji(t){return 0==t?"":t>0?"✔️":t<=-2?"🚫":"⚠️"}getTrendPrint(t){return`(<span style="color: ${t>0?"#2ecc71":t<0?"#e74c3c":"#3498db"}">${t>0?"↑":t<0?"↓":"→"} Δ${Math.abs(t)}</span>)`}getDailyFishingAnalysis(t,e){const n=this.getBaseHourlyImpact(t),i=e.slice(6,12),r=e.slice(12,18),a=e.slice(18,24),s=this.getPressureStats(i),o=this.getPressureStats(r),c=this.getPressureStats(a),l=`\n\t\n\t\t🌅 Утро: ${s.startValue} - ${s.endValue} мм рт.ст. (${this.getTrendPrint(s.trend)}  колебание Δ${s.delta})<br>\n\t\t☀️ День: ${o.startValue} - ${o.endValue} мм рт.ст. (${this.getTrendPrint(o.trend)} колебание Δ${o.delta})<br>\n\t\t🌇 Вечер: ${c.startValue} - ${c.endValue} мм рт.ст. (${this.getTrendPrint(c.trend)} колебание Δ${c.delta})<br>\n\t`.trim(),d=`${n.comment}<br>${l}`;return{weight:n.weight,comment:d}}getBaseHourlyImpact(t){const{avg:e,min:n,max:i,delta:r,startValue:a,endValue:s,trend:o}=t;let c=`Суточное давление: <b>${a} → ${s}</b> мм рт.ст. (${this.getTrendPrint(o)})`,l=0,d=[];return e<=735?(d.push(`🚫 Критически низкое давление (${e} мм) - рыба в глубоких ямах, клёв отсутствует`),l=-3):e>765&&(d.push(`🚫 Очень высокое давление (${e} мм) - лещ пассивен`),l=-3),o<=-7?(d.push(`🌀 Катастрофическое падение (${Math.abs(o)} мм за сутки) - полное прекращение клёва на 24+ часа`),l=-3):o<=-5?(d.push(`⚠️ Сильное падение (${Math.abs(o)} мм) - клёв очень слабый`),l=-2):o>=7?(d.push(`📈 Сильный рост (+${o} мм/24ч) - возможен кратковременный жор`),l=Math.min(l+1,1)):o>=5&&(d.push(`⤴️ Заметный рост (+${o} мм) - хорошие перспективы`),l=Math.min(l+1,1)),r>7?(d.push(`🌀 Экстремальные колебания (Δ${r} мм) - рыба в стрессе`),l=Math.min(l,-2)):r>4&&(o<0?(d.push(`⚠️ Резкие перепады (Δ${r} мм) + общее падение - критично`),l=Math.min(l,-2)):(d.push(`↘️ Заметные колебания (Δ${r} мм) - возможны всплески активности`),l=Math.min(l,-1))),l>-3&&e>=745&&e<=755&&r<=3&&Math.abs(o)<=3&&(d.push("✔️ Идеально: стабильное давление в оптимальном диапазоне"),l=2),c+="<br>"+d.join("<br>"),{weight:Math.max(Math.min(l,2),-3),comment:c}}getBaseImpact(t){const{avg:e,min:n,max:i,delta:r,startValue:a,endValue:s,trend:o}=t;let c=`Давление <b>${a} - ${s}</b> мм рт.ст. ${this.getTrendPrint(o)}`,l=0,d=[];return r<=1&&Math.abs(o)<=1?c+=" (Стабильное)":c+=" (Изменялось)",c+="<br>",e<=735?(d.push(`🚫 Критически низкое давление ${e} мм рт.ст.`),l=-3):e>765&&(d.push(`🚫 Критически высокое давление ${e} мм рт.ст.`),l=-3),l>-3&&(e>=745&&e<=755?r<=1?(d.push(`✔️ Идеальные условия: стабильное давление ${e} мм рт.ст.`),l=2):r<=2&&(d.push(`✔️ Оптимальное давление ${e} мм рт.ст.`),l=1):e>=740&&e<=745?r<=1?(d.push(`✔️ Комфортное и стабильное давление ${e} мм рт.ст.`),l=1):r<=2&&(d.push(`Комфортное давление ${e} мм рт.ст.`),l=0):e>755&&e<=765?(d.push(`⚠️ Повышенное давление ${e} мм рт.ст. — лещ может уйти на глубину`),l=-1):e<740&&e>=736&&(d.push(`⚠️ Среднее давление ${e} мм рт.ст. ниже комфортного для леща — активность падает`),l=-1)),r>1&&l>-3&&(r>4?(d.push(`🚫 Резкий перепад давления Δ${r} мм, тренд ${this.getTrendPrint(o)} мм полностью сбивает клёв`),l=-3):r>2?(d.push(`⚠️ Существенные колебания давления Δ${r} мм, тренд ${this.getTrendPrint(o)} мм мешают стабильному клёву`),l=Math.min(l,-2)):l<2&&(d.push(`↔️ Незначительные колебания давления Δ${r} мм, тренд ${this.getTrendPrint(o)} мм  - не влияют на клев`),l=Math.min(l,0))),r<=4&&l>-3&&Math.abs(o)>3&&(d.push(`⚠️ Заметный ${o>0?"рост":"спад"} ${this.getTrendPrint(o)}`),l=Math.min(l,-1)),c+=d.join("<br>"),d.filter((t=>t.includes("⚠️")||t.includes("🚫"))).length>=2&&l>-3&&(l=Math.min(l,-2)),{weight:l,comment:c}}getDayPressureStats(t){const e=[];if(t.forEach((t=>{const n=t.comment.match(/давление (\d+)/i);n&&e.push(parseInt(n[1]))})),0===e.length)return null;const n=Math.min(...e),i=Math.max(...e),r=e[0],a=e[e.length-1];return{min:n,max:i,start:r,end:a,delta:i-n,trend:a-r}}applySeasonalAdjustments(t,e,n,i){let r={...t};return"winter"===n&&e.avg>=750&&e.delta<=2&&(r.weight+=1,r.comment+=`<br>✔️ Зимой стабильно высокое давление ${e.avg} мм рт.ст. улучшает клёв`),"summer"===n&&"day"===i&&e.avg<740&&(r.weight-=.5,r.comment+=`<br>⚠️ Летом низкое давление днём ${e.avg} мм рт.ст. может снижать активность рыбы`),("spring"===n||"autumn"===n)&&e.delta>2&&(r.comment+=`<br>(в ${n} рыба чувствительна к перепадам)`),r}getPressureStats(t){const e=t.filter((t=>null!==t&&!isNaN(t)));if(0===e.length)return{avg:0,min:0,max:0,delta:0};const n=this.round(e.reduce(((t,e)=>t+e),0)/e.length),i=Math.min(...e),r=Math.max(...e),a=r-i,s=e[0],o=e[e.length-1];return{avg:n,min:i,max:r,delta:a,startValue:s,endValue:o,trend:o-s}}getPressureEmoji(t){return t.delta>4?"🔄 🚫":t.avg<735?"⬇️ 🚫":t.avg>765?"⬆️ 🚫":t.avg>=750&&t.avg<=758&&t.delta<=1||t.avg>=745&&t.avg<750?"✔️":"↔️"}round(t,e=0){return parseFloat(t.toFixed(e))}getPressureTrendDescription(t){if(!t)return"Нет данных о давлении";const e=t.trend>0?"↑":t.trend<0?"↓":"→",n=t.trend>0?"#2ecc71":t.trend<0?"#e74c3c":"#3498db",i=0!==t.trend?`(<span style="color: ${n}">${e} Δ${t.trend}</span>)`:"(→ 0)",r=`Давление <b>${t.startValue}</b> - <b>${t.endValue}</b> мм рт.ст. ${i}`;let a="";return t.trend>3?a=`🚫 🔄 Резкие скачки давления ${t.delta} мм.рт.ст`:t.trend<=1?a=" • Стабильное":t.trend>1?a=` 📈 ⬆️ Плавный рост на (${t.trend} мм рт.ст.)`:t.trend<1&&(trendText=` 📉 ⬇️ Плавное снижение на (${t.trend} мм рт.ст.)`),`${r}${a}`}getTimeRangeForPeriod(t){switch(t){case"morning":return"06:00–12:00";case"day":return"12:00–18:00";case"evening":return"18:00–00:00";case"night":return"00:00–06:00";default:return""}}getPositivePhrase(t){return"<br><b>📌 Благоприятное давление способствует активному клёву</b>"}getNegativePhrase(t){return"<br><b>📌 Неблагоприятное давление снижает активность рыбы. Выбирайте периоды с нормальными показателями давления</b>"}getNeutralPhrase(t){return"<br><b>📌 Давление не оказывает существенного влияния</b>"}}class P{renderMainCurrentDay(t){this.container=document.querySelector(`[data-date="${t.date}"]`),this.mainTodayMainContainer=this.container?.querySelector(".detail-today-main-fishing__main"),this.mainMorningMainContainer=this.container?.querySelector(".detail-morning-main-fishing"),this.mainDayMainContainer=this.container?.querySelector(".detail-day-main-fishing"),this.mainEveningMainContainer=this.container?.querySelector(".detail-evening-main-fishing");const e=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");e.innerHTML=`\n\t\t<div> \n\t\t   ${t.general||""}\n\t\t</div>\n\t\t`,n.innerHTML=`\n\t\t<div>${this.buildHtmlDay(t.details.morning)}</div>\n\t\t`,i.innerHTML=`\n\t\t<div>${this.buildHtmlDay(t.details.day)}</div>\n\t\t`,r.innerHTML=`\n\t\t<div>${this.buildHtmlDay(t.details.evening)}</div>\n\t\t`,this.mainTodayMainContainer?.appendChild(e),this.mainMorningMainContainer?.appendChild(n),this.mainDayMainContainer?.appendChild(i),this.mainEveningMainContainer?.appendChild(r)}buildHtmlDay(t){return`<ul>${t.reduce(((t,e)=>t+"<li>"+e+"</li>"),"")||""}</ul>`}}class x{constructor(t=[]){this.models=t,this.results={},this.mainFishingForecastRender=new P}calculateAll(t,e,n){const i={},r=t=>null==t?[]:Array.isArray(t)?t:[t];for(const a of this.models)try{let s,o=a.getModelType();if(s=o.includes("pressure")?r(e?.pressures||[]):o.includes("wind")?[r(e?.winds||[]),r(e?.pressures||[])]:o.includes("precipitation")?r(n||[]):o.includes("rain")?[r(e?.weatherCodes||[]),r(n||[])]:r(e?.weatherCodes||[]),!s||Array.isArray(s)&&s.some((t=>void 0===t))){console.warn(`Invalid data for ${a.constructor.name}:`,s);continue}a.calculate(s,t),i[o.replace("model","")]=a.getResult()}catch(t){console.error(`Error in ${a.constructor.name}:`,t)}return this.results[t]=i,this.results[t]}getCombinedResult(t){const e=this.results[t];if(!e)return null;const n={date:t,details:{morning:[],day:[],evening:[]},general:[],weights:{general:null,morning:null,day:null,evening:null,model:null}};for(const t in e){const i=e[t];if(i?.details)for(const t of["morning","day","evening"])n.details[t].push(...i.details[t]||[]);i?.general&&n.general.push(`<div class="model-summary">${i.general}</div>`)}for(const t of Object.keys(n.details))0===n.details[t].length&&delete n.details[t];return n.general=this.mergeGeneral(n.general),this.mainFishingForecastRender.renderMainCurrentDay(n),n}mergeGeneral(t){if(!t||0===t.length)return"";const e=[];for(const n of t)n.includes("📊 В целом:")?e.push(n.replace("📊 В целом:","").trim()):e.push(n);const n=[...new Set(e)];return 0===n.length?"":1===n.length?`📊 В целом: ${n[0]}`:`📊 В целом: ${n.join(". ")}`}}class I{constructor(){}renderScoreCurrentDay(t){console.log("scoreData",t),this.container=document.querySelector(`[data-date="${t.date}"]`),this.scoreMorningMainContainer=this.container?.querySelector(".detail-card__morning-fishing"),this.scoreDayMainContainer=this.container?.querySelector(".detail-card__day-fishing"),this.scoreEveningMainContainer=this.container?.querySelector(".detail-card__evening-fishing"),this.scoreMorningMainContainer.classList.add(`${t.morning.ratingForCSS}`),this.scoreDayMainContainer.classList.add(`${t.day.ratingForCSS}`),this.scoreEveningMainContainer.classList.add(`${t.evening.ratingForCSS}`),this.scoreMorningDescriptin=this.scoreMorningMainContainer?.querySelector(".detail-card__morning-descriptin"),this.scoreDayDescriptin=this.scoreDayMainContainer?.querySelector(".detail-card__day-descriptin"),this.scoreEveningDescriptin=this.scoreEveningMainContainer?.querySelector(".detail-card__evening-descriptin"),this.scoreMorningDescriptin.innerHTML=`\n\t\t<b>Прогноз - ${t.morning.rating||""}.</b> ${t.morning.message||""}`,this.scoreDayDescriptin.innerHTML=`\n\t\t<b>Прогноз - ${t.day.rating||""}.</b> ${t.day.message||""}`,this.scoreEveningDescriptin.innerHTML=`\n\t\t<b>Прогноз - ${t.evening.rating||""}.</b> ${t.evening.message||""}`}}class _{constructor(){this.scoreFishingForecastRender=new I,this.baseActivity=.5,this.criticalThresholds={pressure:-2.5,precipitation:-2,wind:-2,rain:-1.5,cloudy:-1.5,season:0},this.timeFactors={morning:1.1,day:.8,evening:1}}getWeights(t){return"day"===t?{pressure:.2,temperature:.28,wind:.18,precipitation:.1,cloudy:.14,rain:.05,moon:.05}:{pressure:.25,temperature:.22,wind:.15,precipitation:.12,cloudy:.1,rain:.08,moon:.08}}normalizeValues(t){return{pressure:t.pressure,precipitation:t.precipitation,wind:this.normalizeWind(t.wind),cloudy:t.cloudy,rain:this.normalizeRain(t.rain),moon:t.moon,temperature:t.temperature,season:this.normalizeSeson(t.season)}}normalizeSeson(t){return{very_weak:0,weak:1,medium:2,good:3,excellent:4}[t]??0}normalizeWind(t){return{4:2,3:1,2:-1,1:-2}[t]??0}normalizeRain(t){return t<=-1.5?-1.5:0===t?0:t>0&&t<=2.6?1.3*t:t>2.6?2.6:t<-1.5?-1.5:t}checkCriticalConditions(t){const e={};return t.pressure<=this.criticalThresholds.pressure&&(e.pressure="давления"),t.precipitation<=this.criticalThresholds.precipitation&&(e.precipitation="осадков"),t.wind<=this.criticalThresholds.wind&&(e.wind="ветра"),t.rain<=this.criticalThresholds.rain&&(e.rain="дождя"),t.cloudy<=this.criticalThresholds.cloudy&&(e.cloudy="жара и безоблачная погода"),t.season<=this.criticalThresholds.season&&(e.season="сезона"),Object.keys(e).length>0?e:null}calculateBiteScore(t,e){const n=this.normalizeValues(t),i=this.checkCriticalConditions(n);if(i)return{scoreSeason:0,score:-3,rating:"Клёва нет",ratingForCSS:"very_weak",message:`Обнаружены критические негативные факторы: ${Object.entries(i).map((([t,e])=>`влияние ${e}`)).join("; ")}`,normalizedScores:n};const r=this.getWeights(e);let a=this.baseActivity+r.pressure*n.pressure+r.temperature*n.temperature+r.precipitation*n.precipitation+r.wind*n.wind+r.cloudy*n.cloudy+r.rain*n.rain+r.moon*n.moon;-2===n.moon?a*=.4:-1===n.moon&&(a*=.9),e&&this.timeFactors[e]&&(a*=this.timeFactors[e]),"day"===e?(n.temperature<=0||n.cloudy<0||n.wind<0)&&(a*=.5):n.wind<0&&(a*=.5),-2===n.pressure?a*=.3:n.pressure<=-1&&(a*=.5),-1.5===n.precipitation&&(a*=.3);let s=0;a>=1.3?s=1:a<=.3?s=-3:a<=.6&&(s=-2);let o=n.season+s;return o=Math.max(0,Math.min(4,o)),{scoreSeason:o,score:a,rating:["Клёва нет","Слабый","Удовлетворительный","Хороший","Отличный"][o],ratingForCSS:["very_weak","weak","medium","good","excellent"][o],message:["Рыба полностью пассивна","Периодическая активность, слабый клёв","Умеренный клёв, нужна тактика","Перспективный период для рыбалки","Активный жор, идеальные условия"][o],normalizedScores:n}}getTimeOfDayForecast(t,e,n,i){const r={date:i,morning:this.calculateBiteScore(t,"morning"),day:this.calculateBiteScore(e,"day"),evening:this.calculateBiteScore(n,"evening")};this.scoreFishingForecastRender.renderScoreCurrentDay(r)}calculateFromCombinedData(t){const e={pressure:t.pressure?.morning??0,precipitation:t.precipitation?.general??0,wind:t.wind?.morning??0,cloudy:t.cloudy?.morning??0,rain:t.rain?.morning??0,moon:t.moon?.morning??0,temperature:t.temperature?.morning??0,season:t.season?.general??0},n={pressure:t.pressure?.day??0,precipitation:t.precipitation?.general??0,wind:t.wind?.day??0,cloudy:t.cloudy?.day??0,rain:t.rain?.day??0,moon:t.moon?.day??0,temperature:t.temperature?.day??0,season:t.season?.general??0},i={pressure:t.pressure?.evening??0,precipitation:t.precipitation?.general??0,wind:t.wind?.evening??0,cloudy:t.cloudy?.evening??0,rain:t.rain?.evening??0,moon:t.moon?.evening??0,temperature:t.temperature?.evening??0,season:t.season?.general??0},r=t.date;return this.getTimeOfDayForecast(e,n,i,r)}}class E{constructor(t,e){this.localFiles=t,this.weatherModel=e,this.precipitationModel=b,this.lunarModel=new w(this.localFiles?.moonCalendar,this.localFiles?.moonTerms),this.seasonModel=new f,this.aggregator=new x([new C,new T,new $,new M,new b]),this.fishBiteForecast=new _}calculateFishingForecast(){const t=new Date,e=this.weatherModel.processorHistoricalData.dataTotalStats,n=this.weatherModel.data.stats,i=p.normalizePrecipitationsData(n,e);for(let e=0;e<6;e++){const n=new Date(t);n.setDate(t.getDate()+e);const r=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`,a=this.weatherModel?.data?.stats[`${r}`]?.weatherCodes?.description||"Переменная облачность",s=this.lunarModel?.calculate(n,a),o=this.seasonModel?.calculate(r,this.localFiles.calendar),c=this.weatherModel.data.daily[`${r}`],l=this.aggregator.calculateAll(r,c,i),[d,h,u]=p.calcTempAvgCurrentTemp(r,i);this.temperatureModel=new D(u,h,d);const m=this.temperatureModel.getForecast(),g={date:r,temperature:{morning:m.morning,day:m.day,evening:m.evening},cloudy:{morning:l.cloudy.weights.morning,day:l.cloudy.weights.day,evening:l.cloudy.weights.evening},rain:{morning:l.rain.weights.morning,day:l.rain.weights.day,evening:l.rain.weights.evening},wind:{morning:l.wind.weights.morning,day:l.wind.weights.day,evening:l.wind.weights.evening},pressure:{morning:l.pressure.weights.morning,day:l.pressure.weights.day,evening:l.pressure.weights.evening},precipitation:{general:l.precipitations.weights.general},moon:{morning:s.morning,day:s.day,evening:s.evening},season:{general:o.level}};this.fishBiteForecast.calculateFromCombinedData(g),this.aggregator.getCombinedResult(r)}}}class H{static setTodayDataAttribute(){const t=document.querySelector(".js-current-fishing");if(!t)return;const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;t.setAttribute("data-date",n)}static renderForecastItems(t){const e=document.querySelector("#fishing-forecast-5days"),n=e.querySelector(".js-fishing-forecast-item");if(!n||!e)return;n.style.display="none";const i=new Date;for(let r=1;r<=t;r++){const t=new Date(i);t.setDate(i.getDate()+r);const a=n.cloneNode(!0),s=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;a.setAttribute("data-date",s),a.style.display="";const o=a.querySelector(".current-date-fishing");o&&(o.textContent=t.toLocaleDateString("ru-RU",{day:"numeric",month:"long",weekday:"short"})),e.appendChild(a)}}static init(){this.setTodayDataAttribute(),this.renderForecastItems(5)}}class A{static show(t){console.error(t)}}function R(){const t=document.querySelectorAll("[data-spollers]");if(t.length>0){const r=Array.from(t).filter((function(t,e,n){return!t.dataset.spollers.split(",")[0]}));r.length>0&&s(r);const a=Array.from(t).filter((function(t,e,n){return t.dataset.spollers.split(",")[0]}));if(a.length>0){const d=[];a.forEach((t=>{const e={},n=t.dataset.spollers.split(",");e.value=n[0],e.type=n[1]?n[1].trim():"max",e.item=t,d.push(e)}));let h=d.map((function(t){return"("+t.type+"-width: "+t.value+"px),"+t.value+","+t.type}));h=h.filter((function(t,e,n){return n.indexOf(t)===e})),h.forEach((t=>{const e=t.split(","),n=e[1],i=e[2],r=window.matchMedia(e[0]),a=d.filter((function(t){if(t.value===n&&t.type===i)return!0}));r.addListener((function(){s(a,r)})),s(a,r)}))}function s(t,e=!1){t.forEach((t=>{t=e?t.item:t,e.matches||!e?(t.classList.add("_init"),o(t),t.addEventListener("click",c)):(t.classList.remove("_init"),o(t,!1),t.removeEventListener("click",c))}))}function o(t,e=!0){const n=t.querySelectorAll("[data-spoller]");n.length>0&&n.forEach((t=>{e?(t.removeAttribute("tabindex"),t.classList.contains("_spoller-active")||(t.nextElementSibling.hidden=!0)):(t.setAttribute("tabindex","-1"),t.nextElementSibling.hidden=!1)}))}function c(t){const n=t.target;if(n.hasAttribute("[data-spoller]")||n.closest("[data-spoller]")){const i=n.hasAttribute("[data-spoller]")?n:n.closest("[data-spoller]"),r=i.closest("[data-spollers]"),a=!!r.hasAttribute("[data-one-spoller]");r.querySelectorAll("._slide").length||(a&&!i.classList.contains("_spoller-active")&&l(r),i.classList.toggle("_spoller-active"),e(i.nextElementSibling,500)),t.preventDefault()}}function l(t){const e=t.querySelector("[data-spoller]._spoller-active");e&&(e.classList.remove("_spoller-active"),_slideUp(e.nextElementSibling,500))}}let e=(t,e=500)=>t.hidden?((t,e=500)=>{if(!t.classList.contains("_slide")){t.classList.add("_slide"),t.hidden&&(t.hidden=!1);let n=t.offsetHeight;t.style.overflow="hidden",t.style.height=0,t.style.paddingTop=0,t.style.paddingButtom=0,t.style.marginTop=0,t.style.marginButtom=0,t.offsetHeight,t.style.transitionProperty="height, margin, padding",t.style.transitionDuration=e+"ms",t.style.height=n+"px",t.style.removeProperty("padding-top"),t.style.removeProperty("padding-buttom"),t.style.removeProperty("margin-top"),t.style.removeProperty("margin-buttom"),window.setTimeout((()=>{t.style.removeProperty("height"),t.style.removeProperty("overflow"),t.style.removeProperty("transition-duration"),t.style.removeProperty("transition-property"),t.classList.remove("_slide")}),e)}})(t,e):((t,e=500)=>{t.classList.contains("_slide")||(t.classList.add("_slide"),t.style.transitionProperty="height, margin, padding",t.style.transitionDuration=e+"ms",t.style.height=t.offsetHeight+"px",t.offsetHeight,t.style.overflow="hidden",t.style.height=0,t.style.paddingTop=0,t.style.paddingButtom=0,t.style.marginTop=0,t.style.marginButtom=0,window.setTimeout((()=>{t.hidden=!0,t.style.removeProperty("height"),t.style.removeProperty("padding-top"),t.style.removeProperty("padding-buttom"),t.style.removeProperty("margin-top"),t.style.removeProperty("margin-buttom"),t.style.removeProperty("overflow"),t.style.removeProperty("transition-duration"),t.style.removeProperty("transition-property"),t.classList.remove("_slide")}),e))})(t,e);const n=document.querySelectorAll(".menu__scroll");n.length>0&&n.forEach((t=>{t.addEventListener("click",(function(t){t.preventDefault();const e=t.target;if(e.href.includes("#")){const t=e.href.split("#")[1],n=document.querySelector("."+t);if(n){const t=n.getBoundingClientRect().top+window.pageYOffset-document.querySelector("header").offsetHeight;window.scrollTo({top:t,behavior:"smooth"})}}}))}));const i=document.getElementById("scrollUpBtn");window.addEventListener("scroll",(()=>{window.scrollY>300?i.classList.add("active"):i.classList.remove("active")})),i.addEventListener("click",(()=>{window.scrollTo({top:0,behavior:"smooth"})})),function(t){let e=new Image;1==(2==e.height)?document.querySelector("body").classList.add("webp"):document.querySelector("body").classList.add("no-webp"),e.onload=e.onerror=function(){},e.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA"}()}new class{constructor(){this.WeatherModel=new h,this.FishingForecastModel=null,this.parentContainer=document.querySelector("#fishing-forecast-5days"),this.template=this.parentContainer.querySelector(".js-fishing-forecast-item"),this.init()}init(){document.addEventListener("DOMContentLoaded",(async()=>{await this.onDOMLoaded()}))}async onDOMLoaded(){H.init(),this.displayCurrentDate();try{document.getElementById("loading").style.display="block";const[t,e,n]=await Promise.all([m.fetchWeather(),m.fetchHistoricalData(),g.loadAll()]);this.WeatherModel.updateHistoricalData(e),this.WeatherModel.updateDailyData(t),this.FishingForecastModel=new E(n,this.WeatherModel),this.FishingForecastModel.calculateFishingForecast(),this.spollers=R()}catch(t){console.error("Ошибка инициализации:",t),A.show(t)}finally{document.getElementById("loading").style.display="none"}}displayCurrentDate(){const t=(new Date).toLocaleDateString("ru-RU",{weekday:"long",year:"numeric",month:"long",day:"numeric"});document.querySelectorAll(".current-date").forEach((e=>{e.textContent=t}))}}})();